<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Financial Simulator - JavaScript</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.1/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.4.4/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/seedrandom.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color: #333;
            --muted-text-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            font-weight: 700;
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .section-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 35px 50px 30px 50px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 32px 32px;
            margin-bottom: 24px;
        }

        .section-card+.section-card {
            margin-top: 40px;
        }

        label>input {
            margin-top: 6px;
        }

        .lump-sum-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 32px;
            align-items: end;
        }

        label {
            display: flex;
            flex-direction: column;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .button-container {
            margin: 30px 0;
        }

        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #a0a0a0;
        }

        #add_asset,
        #toggle_assets,
        #toggle_lumps {
            padding: 10px;
            font-size: 18px;
            min-width: 42px;
            align-self: end;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        th,
        td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 700;
            color: var(--muted-text-color);
            font-size: 12px;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        td button {
            background-color: var(--danger-color);
        }

        td button:hover {
            background-color: #a71d2a;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-content pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .assets-input-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr) auto;
            gap: 32px;
            align-items: end;
            margin-bottom: 24px;
        }

        .info-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background-color: transparent;
            color: var(--primary-color);
        }

        .info-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 30px;
        }

        .header-buttons button {
            margin-left: 10px;
        }

        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .results-table {
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            background-color: var(--background-color);
            font-weight: 600;
        }

        /* Keep label text on its own line, wrap if necessary,
           but prevent the input from being pushed too far down */
        label span {
            display: block;
            /* forces label text onto its own line */
            line-height: 1.2;
            /* tighter text so cell height stays reasonable */
            margin-bottom: 4px;
            /* breathing room above the input */
            white-space: normal;
            /* let it wrap instead of widening the grid cell */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Financial Simulator</h1>
            <div class="header-buttons">
                <button id="openInstructions" style="font-size: 14px; font-weight: 500;">Interpreting Results</button>
                <button id="openFEV" style="font-size: 14px; font-weight: 500;">What is FEV?</button>
            </div>
        </div>

        <div class="section-card">
            <h3>Quick Start</h3>
            <p>It would be trivial to make the best financial decisions if you had a crystal ball that could tell you
                the
                rate of return every asset would get every year,
                every time an unexpected expense would pop up, etc. While we don't have a crystal ball, we can do much
                better than just <b>random guessing</b> because we do have <b>historical statistics</b> about how
                certain assset
                classes have performed in the past. </p>
            <p>
                For instance, the SP500 has historically returned about 10.5% per year with a standard deviation of
                18.5%. This means each year there is a 68% chance that the return will be between -8.0% and 29.0%.
                This program runs many simulations of your financial future, and then does statistics on the results.
            </p>
            <hr />
            <p>
                Most people would vary the input parameters and run multiple simulations. This could help you answer
                questions like:
            <ul></ul>
            <li>How many years will you need to work?</li>
            <li>How sensitive is your situation to unexpected expenses?</li>
            <li>How will refinancing your mortgage today affect your future 10 years from now?</li>
            <li>How much you will be able to afford to contribute to children's college expenses in 12 years?</li>
            <li>How will the composition of your portfolio change over time as different assets have different returns?
            </li>
            <li>How will your situation change with 3% vs 5% inflation?</li>
            </ul>
            </p>
            <p>Click on the info button next to each section to see important details and caveats</p>
        </div>

        <div class="section-card">
            <h3>General Parameters <button class="info-btn" data-info="general">ℹ️</button></h3>
            <div class="input-grid">
                <label>Random Seed <input id="seed" type="number" value="42"></label>
                <label>Years <input id="years" type="number" value="20"></label>
                <label>Simulations <input id="sims" type="number" value="100"></label>
                <label>Tax Rate (% as decimal) <input id="tax_rate" type="number" value="0.2" step="0.01"></label>
                <label>Inflation (% as decimal) <input id="inflation" type="number" value="0.03" step="0.01"></label>
                <label>Depletion Threshold ($) <input id="depletion" class="format-number" type="text"
                        value="20000"></label>
                <label>Excess Cash Goes To
                    <select id="cash_target">
                        <option value="assets" selected>Assets</option>
                        <option value="liabilities">Liabilities</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="section-card">
            <h3>Assets <button class="info-btn" data-info="assets">ℹ️</button><button id="toggle_assets"
                    style="margin-left:auto;">+</button></h3>
            <div id="assets_section" style="display:none;">
                <!-- Input row for creating a new asset -->
                <div class="assets-input-row">
                    <label>Name <input id="asset_name" type="text" placeholder="e.g. Index Fund"></label>
                    <label>Value ($) <input id="asset_value" class="format-number" type="text"
                            placeholder="100,000"></label>
                    <label>Expected Return Mean (% as decimal) <input id="asset_ret_mean" type="number" step="0.001"
                            placeholder="0.07"></label>
                    <label>Expected Return SD (% as decimal) <input id="asset_ret_sd" type="number" step="0.001"
                            placeholder="0.15"></label>
                    <button id="add_asset" class="icon-btn">+</button>
                </div>

                <!-- Table displaying current assets -->
                <div id="assets_table_container" style="margin-top: 10px;">
                    <table id="assets_table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Value ($)</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Mean %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">SD %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="assets_body"></tbody>
                    </table>
                </div>

                <!-- Error message for asset input -->
                <div id="asset_error" style="color: red; margin-top: 5px;"></div>
            </div> <!-- End assets_section -->
        </div>

        <div class="section-card">
            <h3>Liabilities <button class="info-btn" data-info="liabilities">ℹ️</button><button id="toggle_liabilities"
                    style="margin-left:auto;">+</button></h3>
            <div id="liabilities_section" style="display:none;">
                <div class="assets-input-row"> <!-- reuse grid style -->
                    <label>Name <input id="liability_name" type="text" placeholder="e.g. Credit Card"></label>
                    <label>Amount ($) <input id="liability_value" class="format-number" type="text"
                            placeholder="20,000"></label>
                    <label>Expected Interest Mean (% as decimal) <input id="liability_ret_mean" type="number"
                            step="0.001" placeholder="-0.15"></label>
                    <label>Interest SD (% as decimal) <input id="liability_ret_sd" type="number" step="0.001"
                            placeholder="0.05"></label>
                    <button id="add_liability" class="icon-btn">+</button>
                </div>
                <div id="liabilities_table_container" style="margin-top:10px;">
                    <table style="width:100%; border-collapse:collapse;" id="liabilities_table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Amount ($)</th>
                                <th>Mean %</th>
                                <th>SD %</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="liabilities_body"></tbody>
                    </table>
                </div>
                <div id="liability_error" style="color:red; margin-top:5px;"></div>
            </div>
        </div>

        <div class="section-card">
            <h3>Active Income <button class="info-btn" data-info="active">ℹ️</button></h3>
            <div class="input-grid">
                <label>Active Income ($) <input id="active_income" class="format-number" type="text"
                        value="65000"></label>
                <label>Growth Rate (% as decimal) <input id="active_growth" type="number" value="0.02"
                        step="0.01"></label>
                <label>Years to Work <input id="years_work" type="number" value="15"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Passive Income <button class="info-btn" data-info="passive">ℹ️</button></h3>
            <div class="input-grid">
                <label>Additional Passive Income ($) <input id="passive_income" class="format-number" type="text"
                        value="5000"></label>
                <label>Growth Rate (% as decimal) <input id="passive_growth" type="number" value="0.02"
                        step="0.01"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Expenses <button class="info-btn" data-info="expenses">ℹ️</button></h3>
            <div class="input-grid">
                <label>Expected Expenses Mean ($) <input id="exp_mean" class="format-number" type="text"
                        value="50000"></label>
                <label>Expected Expenses SD ($) <input id="exp_sd" class="format-number" type="text"
                        value="10000"></label>
                <label>Chance Per Year (% as decimal) <input id="unexpected_chance" type="number" value="0.15"
                        step="0.01"></label>
                <label>Unexpected Expense Amount ($) <input id="unexpected_amount" class="format-number" type="text"
                        value="10000"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Lump Sums <button class="info-btn" data-info="lumps">ℹ️</button><button id="toggle_lumps"
                    style="margin-left:auto;">+</button></h3>
            <div id="lump_section" style="display:none;">
                <div class="lump-sum-input-row">
                    <label>Year <input id="lump_year" type="number" min="1" value="1"></label>
                    <label>Amount ($) <input id="lump_amount" class="format-number" type="text" value="0"></label>
                    <button id="add_lump_sum" class="icon-btn">+</button>
                </div>
                <div id="lump_sums_table_container" style="margin-top: 20px;">
                    <table id="lump_sums_table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="lump_sums_body">
                        </tbody>
                    </table>
                </div>
            </div> <!-- end lump_section -->
        </div>

        <div class="button-container">
            <button id="run">Run Simulation</button>
            <button id="export_pdf" style="display: none;">Export to PDF</button>
        </div>

        <div id="results"></div>

        <!-- Instructions Modal -->
        <div id="instructionsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeInstructions">&times;</span>
                <h2>Financial Simulator - Intrepreting Results</h2>
                <p><em>"It's hard to make predictions – especially about the future." – Yogi Berra</em></p>

                <h3>How It Works</h3>
                <p>The simulator performs many Monte Carlo trials (&ldquo;Simulations&rdquo;) using the parameters you
                    provide. Each trial randomly samples investment returns, inflation, and expenses to create a
                    possible future trajectory for your finances. Results are aggregated to show medians, distributions,
                    and probabilities.</p>

                <p><b>Medians</b> show the value where half of the simulations came in above and half are below.
                    this is similar to the <b>average</b>, but averages can be more skewed by extreme high or low values
                    (outliers). </p>

                <p><b>Probabilities</b> give the chance of a certain outcome happening. For instance, you might be
                    considering whether to take on a certain monthly
                    expense. The simulator could tell you if it increased your chance of running out of money from 5% to
                    12%. Similarly, perhaps working 1 more year
                    increases your chance of achieving FEV from 10% to 30%. </p>

                <p><b>Distributions</b> show how the probabilities are spread through most outcomes. Normal
                    distributions are assumed for most of this modeling.
                    For instance, the box plot shows the median, the 25th and 75th percentiles, and the 10th and 90th
                    percentiles.
                </p>

                <h3>Interpreting Results</h3>
                <p>After running, you&rsquo;ll receive:</p>
                <ul>
                    <li><b>Median Trajectories &amp; Box Plots</b> for investable assets.</li>
                    <li><b>Income vs. Expenses</b> charts.</li>
                    <li><b>Key Insights</b> table – chance of depletion, chance of achieving FEV, etc.</li>
                </ul>
                <p> The key insights table gives you a high level overview of the results. </p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/key_insights.jpg"
                    alt="Key Insights" style="max-width: 100%; margin: 10px 0;" />
                <p> The summary table shows the median values for each year. Remember, assets are only sold and
                    capital gains taxes are only paid when expenses cannot be covered by active income alone. </p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/table1.png"
                    alt="Summary Table" style="max-width: 100%; margin: 10px 0;" />
                <p> The assets over years graph shows how your net worth changed over time. Each line represents a
                    different simulation.
                    Results are clustered closer together at the beginning and spread out over time. </p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/assets_over_years.jpg"
                    alt="Assets Over Years" style="max-width: 100%; margin: 10px 0;" />
                <p> This is the same information but in box plot format</p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/assets_over_time.png?raw=true"
                    alt="Asset Allocation Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p> The median asset allocation over time shows how the values of your assets and liabilities have
                    changed over years.</p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/asset_allocation_over_time.png?raw=true"
                    alt="Assets Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p> The ending assets graph shows the distribution of the final net worth for each simulation. </p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/ending_assets.png?raw=true"
                    alt="Ending Assets" style="max-width: 100%; margin: 10px 0;" />

            </div>
        </div>

        <!-- Card Info Modal -->
        <div id="cardInfoModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeCardInfo">&times;</span>
                <div id="cardInfoBody"></div>
            </div>
        </div>

        <!-- FEV Modal -->
        <div id="fevModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeFEV">&times;</span>
                <h2>Financial Escape Velocity (FEV)</h2>
                <p>This is a graph of net worth over time for a typical person. Generally, their net worth will increase
                    until they retire, but then it will decrease as they start to spend down their assets. The question
                    of
                    retirement becomes "will I run out of money before I die?"</p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/net_worth_over_time.png"
                    alt="Net Worth Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p></p> Another, related but more difficult goal to achieve is what I call <b>'Financial Escape
                    Velocity'</b>, or being able to increase your net worth through passive and investment income. This
                is similar to how a rocket needs to reach a certain speed to escape Earth's gravity - once achieved, the
                momentum becomes self-sustaining. Those who achieve FEV will generally have their net worth
                <em>increase</em>
                with age. </p>
                <p>Imagine - if your income is $1,000 / month in retirement - if you spend $1,001 per month, eventually
                    you will run out of money. However, if you spend $999 per month, you will increase your assets each
                    month.</p>

                <p>The simulator looks across every single Monte-Carlo trial and flags the first year where:</p>
                <ul>
                    <li>Passive&nbsp;Income&nbsp;+ Median&nbsp;Asset&nbsp;Return ≥ Expenses</li>
                    <li>and the <em>cumulative</em> income after that point continues to outpace cumulative expenses.
                    </li>
                </ul>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/fev_graph.jpg"
                    alt="FEV graph" style="max-width: 100%; margin: 10px 0;" />


                <p>The green line represents covering 100% of your expenses with passive and investment income. The box
                    plots show the distribution of times that it happened.
                    For instance, if the lower 'wisker' of the box plot is over the green line, you have a 90% chance of
                    covering all your expenses that year.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Financial Simulator - JavaScript Implementation

        // Global state
        let assetList = [];
        let liabilityList = [];
        let lumpSums = new Map();
        let charts = [];
        let rng = null;

        // Utility functions
        function stripCommas(str) {
            return str.replace(/,/g, '');
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        // Box-Muller transform for normal distribution
        function randomNormal(mean = 0, stdDev = 1) {
            let u = 0, v = 0;
            while (u === 0) u = rng(); // Converting [0,1) to (0,1)
            while (v === 0) v = rng();

            const z0 = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
            return z0 * stdDev + mean;
        }

        // Input parsing and validation
        function parseInputs() {
            const getValue = (id) => stripCommas(document.getElementById(id).value);

            // Compute portfolio stats from assets + liabilities
            const combined = [...assetList, ...liabilityList];
            let totalVal = combined.reduce((sum, a) => sum + a.value, 0);
            let weightedMean = 0;
            let weightedVar = 0;
            if (combined.length > 0 && totalVal !== 0) {
                const weights = combined.map(a => a.value / totalVal);
                weightedMean = combined.reduce((sum, a, i) => sum + weights[i] * a.mean, 0);
                weightedVar = combined.reduce((sum, a, i) => sum + (weights[i] ** 2) * (a.sd ** 2), 0);
            }

            const params = {
                'Random Seed': parseInt(getValue('seed')),
                'Years': parseInt(getValue('years')),
                'Simulations': parseInt(getValue('sims')),
                'Tax Rate': parseFloat(getValue('tax_rate')),
                'Inflation': parseFloat(getValue('inflation')),
                'Depletion Threshold': parseFloat(getValue('depletion')),
                'Investable Assets': totalVal,
                'Expected Return Mean': weightedMean,
                'Expected Return SD': Math.sqrt(weightedVar),
                'Expected Expenses Mean': parseFloat(getValue('exp_mean')),
                'Expected Expenses SD': parseFloat(getValue('exp_sd')),
                'Unexpected Expense Chance': parseFloat(getValue('unexpected_chance')),
                'Unexpected Expense Amount': parseFloat(getValue('unexpected_amount')),
                'Additional Passive Income': parseFloat(getValue('passive_income')),
                'Passive Income Growth Rate': parseFloat(getValue('passive_growth')),
                'Active Income': parseFloat(getValue('active_income')),
                'Active Income Growth Rate': parseFloat(getValue('active_growth')),
                'Years to Work': parseInt(getValue('years_work')),
                'Cash Target': document.getElementById('cash_target').value // 'assets' or 'liabilities'
            };

            return { params, lumpSums };
        }

        // Core Monte Carlo simulation
        function runSimulation(params, lumpSumChanges) {
            // Set up seeded random number generator
            rng = new Math.seedrandom(params['Random Seed']);

            const NUM_SIMULATIONS = params['Simulations'];
            const NUM_YEARS = params['Years'];

            // ---- Build extended asset list (individual assets + cash bucket) ----
            const extendedAssets = [...assetList.map(a => ({ ...a })), ...liabilityList.map(l => ({ ...l }))];
            const cashBucket = { name: 'General Cash', value: 0, mean: 0, sd: 0 };
            extendedAssets.push(cashBucket);
            const cashIdx = extendedAssets.length - 1;

            const assetNames = extendedAssets.map(a => a.name);

            // ---- Convenience parameter aliases ----
            const initialYearlyExpenses = params['Expected Expenses Mean'];
            const expensesVolatility = params['Expected Expenses SD'];
            const inflation = params['Inflation'];
            const unexpectedChance = params['Unexpected Expense Chance'];
            const unexpectedAmount = params['Unexpected Expense Amount'];

            const passiveBase = params['Additional Passive Income'];
            const passiveGrowth = params['Passive Income Growth Rate'];
            const activeBase = params['Active Income'];
            const activeGrowth = params['Active Income Growth Rate'];
            const yearsToWork = params['Years to Work'];
            const taxRate = params['Tax Rate'];
            const cashTarget = params['Cash Target'];

            // ---- Precompute income trajectories (deterministic) ----
            const activeIncomeOverYears = Array.from({ length: NUM_YEARS }, (_, y) => (y < yearsToWork ? activeBase * Math.pow(1 + activeGrowth, y) : 0));
            const passiveIncomeOverYears = Array.from({ length: NUM_YEARS }, (_, y) => passiveBase * Math.pow(1 + passiveGrowth, y));

            // ---- Result containers ----
            const assetsOverYears = Array.from({ length: NUM_SIMULATIONS }, () => Array(NUM_YEARS).fill(0));
            const netAssetIncomeOverYears = Array.from({ length: NUM_SIMULATIONS }, () => Array(NUM_YEARS).fill(0));
            const expensesOverYears = Array.from({ length: NUM_SIMULATIONS }, () => Array(NUM_YEARS).fill(0));
            const taxesOverYears = Array.from({ length: NUM_SIMULATIONS }, () => Array(NUM_YEARS).fill(0));
            const assetValuesOverYears = Array.from({ length: NUM_SIMULATIONS }, () => Array.from({ length: NUM_YEARS }, () => Array(extendedAssets.length).fill(0)));

            // Helper to draw normal random number
            const drawNormal = (mean, sd) => randomNormal(mean, sd);

            // Determine asset and liability indices based on initial sign
            const assetIdxsStatic = extendedAssets.map((a, idx) => a.value >= 0 ? idx : null).filter(i => i !== null);
            const liabilityIdxsStatic = extendedAssets.map((a, idx) => a.value < 0 ? idx : null).filter(i => i !== null);

            for (let sim = 0; sim < NUM_SIMULATIONS; sim++) {
                let values = extendedAssets.map(a => a.value); // numeric array

                for (let year = 0; year < NUM_YEARS; year++) {
                    // 1) Apply stochastic returns to each asset (skip cash bucket)
                    const assetGains = values.map((val, idx) => {
                        if (idx === cashIdx) return 0;
                        if (val === 0) return 0;
                        const mu = extendedAssets[idx].mean;
                        const sigma = extendedAssets[idx].sd;
                        return val * drawNormal(mu, sigma);
                    });
                    // Update asset values after gains
                    values = values.map((val, idx) => val + assetGains[idx]);

                    // 2) Apply lump sum changes to cash bucket
                    if (lumpSumChanges.has(year + 1)) {
                        values[cashIdx] += lumpSumChanges.get(year + 1);
                    }

                    // 3) Add active & passive income to cash bucket
                    values[cashIdx] += activeIncomeOverYears[year] + passiveIncomeOverYears[year];

                    // 4) Compute expenses (with volatility & inflation) & unexpected expenses
                    let yearlyExpenses = drawNormal(initialYearlyExpenses, expensesVolatility);
                    yearlyExpenses *= Math.pow(1 + inflation, year);
                    if (rng() < unexpectedChance) yearlyExpenses += unexpectedAmount;

                    // 5) Pay expenses from cash bucket; liquidate assets if needed
                    values[cashIdx] -= yearlyExpenses;
                    let taxesPaid = 0;
                    if (values[cashIdx] < 0) {
                        const shortfall = -values[cashIdx];
                        const assetsToSell = shortfall / (1 - taxRate);
                        taxesPaid = assetsToSell - shortfall;

                        // Sell assets proportionally based on positive values (exclude cash bucket)
                        const positiveVals = values.map(v => Math.max(v, 0));
                        const posTotal = positiveVals.reduce((a, b) => a + b, 0);
                        if (posTotal > 0) {
                            values = values.map((v, idx) => {
                                if (idx === cashIdx) return v + assetsToSell; // proceeds go to cash first
                                if (v > 0) {
                                    const reduction = assetsToSell * (positiveVals[idx] / posTotal);
                                    return v - reduction;
                                }
                                return v;
                            });
                            // Cash covers taxes
                            values[cashIdx] -= taxesPaid;
                        } else {
                            // No positive assets; carry negative cash (general debt)
                        }
                    }

                    // --- Ensure liabilities never become positive; redirect overflow to assets ---
                    let residualCash = values[cashIdx];
                    if (extendedAssets.length === 1 && assetList.length === 0) {
                        // No assets/liabilities defined – keep residual in cash.
                    } else if (Math.abs(residualCash) > 1e-9) {
                        if (cashTarget === 'assets' && assetIdxsStatic.length > 0) {
                            // Split residual evenly across assets
                            const per = residualCash / assetIdxsStatic.length;
                            assetIdxsStatic.forEach(i => { values[i] += per; });
                            values[cashIdx] = 0;
                        } else if (cashTarget === 'liabilities' && liabilityIdxsStatic.length > 0) {
                            // Use surplus to pay down liabilities (or use deficit to increase them)
                            let remaining = residualCash;
                            // Surplus: positive remaining, reduce liabilities toward 0
                            if (remaining > 0) {
                                liabilityIdxsStatic.forEach(i => {
                                    if (remaining <= 0) return;
                                    const needed = -values[i]; // positive amount to bring liability to 0
                                    const pay = Math.min(needed, remaining / liabilityIdxsStatic.length);
                                    values[i] += pay;
                                    remaining -= pay;
                                });
                            } else { // Deficit: negative remaining – distribute equally making liabilities more negative
                                const per = remaining / liabilityIdxsStatic.length;
                                liabilityIdxsStatic.forEach(i => { values[i] += per; });
                                remaining = 0;
                            }
                            values[cashIdx] = 0; // after applying we zero out cash
                            // Any leftover surplus after paying all liabilities -> assets
                            if (remaining > 0 && assetIdxsStatic.length > 0) {
                                const perAsset = remaining / assetIdxsStatic.length;
                                assetIdxsStatic.forEach(i => { values[i] += perAsset; });
                            }
                        }
                    }

                    // 6) Store results
                    const totalAssets = values.reduce((sum, v) => sum + v, 0);
                    assetsOverYears[sim][year] = totalAssets;
                    netAssetIncomeOverYears[sim][year] = assetGains.reduce((sum, g) => sum + g, 0);
                    expensesOverYears[sim][year] = yearlyExpenses;
                    taxesOverYears[sim][year] = taxesPaid;
                    assetValuesOverYears[sim][year] = values.slice(); // copy
                }
            }

            return {
                assetsOverYears,
                netAssetIncomeOverYears,
                expensesOverYears,
                taxesOverYears,
                passiveIncomeOverYears,
                activeIncomeOverYears,
                assetValuesOverYears,
                assetNames,
                depletionThreshold: params['Depletion Threshold']
            };
        }

        // Generate results table
        function generateResultsTable(data) {
            const medianAssets = data.assetsOverYears[0].map((_, yearIdx) => {
                const yearData = data.assetsOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const incomeFromAssets = data.netAssetIncomeOverYears[0].map((_, yearIdx) => {
                const yearData = data.netAssetIncomeOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const annualExpenses = data.expensesOverYears[0].map((_, yearIdx) => {
                const yearData = data.expensesOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const annualTaxes = data.taxesOverYears[0].map((_, yearIdx) => {
                const yearData = data.taxesOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            return medianAssets.map((assets, i) => ({
                Year: i + 1,
                Assets: `$${formatCurrency(assets)}`,
                'Income from Assets': `$${formatCurrency(incomeFromAssets[i])}`,
                'Expenses': `$${formatCurrency(annualExpenses[i])}`,
                'Investment Taxes': `$${formatCurrency(annualTaxes[i])}`
            }));
        }

        // Calculate end statistics
        function calculateEndStats(data, params) {
            const assetsOverYears = data.assetsOverYears;
            const depletionThreshold = params['Depletion Threshold'];
            const NUM_SIMULATIONS = assetsOverYears.length;
            const NUM_YEARS = assetsOverYears[0].length;

            const endOfSimulationAssets = assetsOverYears.map(sim => sim[NUM_YEARS - 1]);

            // Calculate depletion statistics
            const yearsOfDepletion = assetsOverYears.map(sim => {
                const depletionYear = sim.findIndex(assets => assets <= depletionThreshold);
                return depletionYear === -1 ? NUM_YEARS + 1 : depletionYear;
            });

            const neverDepleted = yearsOfDepletion.filter(year => year === NUM_YEARS + 1);
            const depleted = yearsOfDepletion.filter(year => year !== NUM_YEARS + 1);
            const medianYearDepleted = depleted.length > 0 ? ss.median(depleted) : NUM_YEARS + 1;

            const simulationsWithDepletion = assetsOverYears.filter(sim =>
                sim.some(assets => assets <= depletionThreshold)
            );
            const depletionPercentage = (simulationsWithDepletion.length / NUM_SIMULATIONS) * 100;

            // Calculate FEV statistics
            let countSatisfyingSimulations = 0;
            const firstExceedingYearsList = [];

            for (let i = 0; i < NUM_SIMULATIONS; i++) {
                const netAssetIncomeSimulation = data.netAssetIncomeOverYears[i];
                const combinedIncomeSimulation = netAssetIncomeSimulation.map((income, year) =>
                    income + data.passiveIncomeOverYears[year]
                );

                const exceedingYears = combinedIncomeSimulation
                    .map((income, year) => income > data.expensesOverYears[i][year] ? year : -1)
                    .filter(year => year !== -1);

                if (exceedingYears.length > 0) {
                    const firstExceedingYear = exceedingYears[0];
                    const totalIncomeSubsequentYears = combinedIncomeSimulation
                        .slice(firstExceedingYear)
                        .reduce((sum, income) => sum + income, 0);
                    const totalExpensesSubsequentYears = data.expensesOverYears[i]
                        .slice(firstExceedingYear)
                        .reduce((sum, expense) => sum + expense, 0);

                    if (totalIncomeSubsequentYears > totalExpensesSubsequentYears) {
                        countSatisfyingSimulations++;
                        firstExceedingYearsList.push(firstExceedingYear);
                    }
                }
            }

            const medianFirstExceedingYear = firstExceedingYearsList.length > 0 ?
                ss.median(firstExceedingYearsList) : 0;

            return {
                "Median investable assets left at the end": `$${formatCurrency(ss.median(endOfSimulationAssets))}`,
                "Percentage of simulations where assets were ever depleted": `${depletionPercentage.toFixed(2)}%`,
                "Median year assets depleted": medianYearDepleted !== NUM_YEARS + 1 && !isNaN(medianYearDepleted) ?
                    `Year ${medianYearDepleted.toFixed(1)}` : "Never",
                "Percentage of simulations achieving escape velocity": `${((countSatisfyingSimulations * 100) / NUM_SIMULATIONS).toFixed(2)}%`,
                "Median first year escape": `${medianFirstExceedingYear.toFixed(0)}`
            };
        }

        // Destroy existing charts
        function destroyOldCharts() {
            charts.forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            charts = [];
        }

        // Create charts using Chart.js
        function createCharts(data, params) {
            destroyOldCharts();

            const resultsDiv = document.getElementById('results');
            const NUM_YEARS = data.assetsOverYears[0].length;
            const initialInvestableAssets = params['Investable Assets'];

            // Chart 1: Individual simulation trajectories
            const chartContainer1 = document.createElement('div');
            chartContainer1.className = 'chart-container';
            chartContainer1.innerHTML = '<canvas id="trajectoryChart"></canvas>';
            resultsDiv.appendChild(chartContainer1);

            const ctx1 = document.getElementById('trajectoryChart').getContext('2d');
            const trajectoryLabels = Array.from({ length: NUM_YEARS }, (_, i) => i + 1);
            const trajectoryData = {
                labels: trajectoryLabels,
                datasets: data.assetsOverYears.slice(0, Math.min(50, data.assetsOverYears.length)).map((sim, i) => ({
                    label: `Simulation ${i + 1}`,
                    data: sim, // direct numeric array aligns with labels
                    borderColor: 'rgba(0, 123, 255, 0.15)',
                    backgroundColor: 'rgba(0, 123, 255, 0.05)',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                }))
            };

            charts.push(new Chart(ctx1, {
                type: 'line',
                data: trajectoryData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Assets over Years for Each Simulation'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Assets ($)'
                            }
                        }
                    }
                }
            }));

            // Chart 2: Box plot of assets over years
            const chartContainer2 = document.createElement('div');
            chartContainer2.className = 'chart-container';
            chartContainer2.innerHTML = '<canvas id="boxPlotChart"></canvas>';
            resultsDiv.appendChild(chartContainer2);

            const ctx2 = document.getElementById('boxPlotChart').getContext('2d');

            // Calculate medians and box plot data
            const medians = data.assetsOverYears[0].map((_, yearIdx) => {
                const yearData = data.assetsOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const extendedYears = [0, ...Array.from({ length: NUM_YEARS }, (_, i) => i + 1)];
            const extendedMedians = [initialInvestableAssets, ...medians];

            // Box plot data for each year
            const boxPlotData = extendedYears.map(year => {
                if (year === 0) {
                    return {
                        x: year,
                        min: initialInvestableAssets,
                        q1: initialInvestableAssets,
                        median: initialInvestableAssets,
                        q3: initialInvestableAssets,
                        max: initialInvestableAssets
                    };
                }

                const yearData = data.assetsOverYears.map(sim => sim[year - 1]);
                yearData.sort((a, b) => a - b);

                return {
                    x: year,
                    min: ss.min(yearData),
                    q1: ss.quantile(yearData, 0.25),
                    median: ss.median(yearData),
                    mean: ss.mean(yearData),
                    q3: ss.quantile(yearData, 0.75),
                    max: ss.max(yearData)
                };
            });

            charts.push(new Chart(ctx2, {
                type: 'boxplot',
                data: {
                    labels: extendedYears,
                    datasets: [{
                        label: 'Asset Distribution',
                        data: boxPlotData,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Median',
                        type: 'line',
                        data: extendedMedians.map((value, i) => ({ x: i, y: value })),
                        borderColor: 'red',
                        backgroundColor: 'red',
                        pointBackgroundColor: 'red',
                        pointBorderColor: 'red',
                        pointRadius: 4,
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Box Plot of Investable Assets Over Years'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const v = context.raw;
                                    if (!v || typeof v !== 'object') return '';
                                    return [
                                        `Min: $${formatCurrency(v.min)}`,
                                        `Q1: $${formatCurrency(v.q1)}`,
                                        `Median: $${formatCurrency(v.median)}`,
                                        `Mean: $${formatCurrency(v.mean)}`,
                                        `Q3: $${formatCurrency(v.q3)}`,
                                        `Max: $${formatCurrency(v.max)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Investable Assets ($)'
                            }
                        }
                    }
                }
            }));

            // Chart 3: Income vs Expenses
            const chartContainer3 = document.createElement('div');
            chartContainer3.className = 'chart-container';
            chartContainer3.innerHTML = '<canvas id="incomeExpensesChart"></canvas>';
            resultsDiv.appendChild(chartContainer3);

            const ctx3 = document.getElementById('incomeExpensesChart').getContext('2d');

            const medianNetAssetIncome = data.netAssetIncomeOverYears[0].map((_, yearIdx) => {
                const yearData = data.netAssetIncomeOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const medianExpenses = data.expensesOverYears[0].map((_, yearIdx) => {
                const yearData = data.expensesOverYears.map(sim => sim[yearIdx]);
                return ss.median(yearData);
            });

            const years = Array.from({ length: NUM_YEARS }, (_, i) => i + 1);

            charts.push(new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Median Net Asset Income',
                        data: medianNetAssetIncome,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: false
                    }, {
                        label: 'Median Expenses',
                        data: medianExpenses,
                        borderColor: 'red',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        fill: false
                    }, {
                        label: 'Active Income',
                        data: data.activeIncomeOverYears,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        fill: false
                    }, {
                        label: 'Passive Income',
                        data: data.passiveIncomeOverYears,
                        borderColor: 'purple',
                        backgroundColor: 'rgba(128, 0, 128, 0.1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Income and Expenses Over Years'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    }
                }
            }));

            // Chart 4: Income vs Expenses with Lump Sums
            if (lumpSums.size > 0) {
                const chartContainer4 = document.createElement('div');
                chartContainer4.className = 'chart-container';
                chartContainer4.innerHTML = '<canvas id="incomeExpensesLumpChart"></canvas>';
                resultsDiv.appendChild(chartContainer4);

                const ctx4 = document.getElementById('incomeExpensesLumpChart').getContext('2d');

                const lumpSumData = Array.from(lumpSums.entries()).map(([year, amount]) => ({
                    x: year,
                    y: amount
                }));

                charts.push(new Chart(ctx4, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Median Net Asset Income',
                            data: medianNetAssetIncome,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            fill: false,
                            type: 'line'
                        }, {
                            label: 'Median Expenses',
                            data: medianExpenses,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            fill: false,
                            type: 'line'
                        }, {
                            label: 'Active Income',
                            data: data.activeIncomeOverYears,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 255, 0, 0.1)',
                            fill: false,
                            type: 'line'
                        }, {
                            label: 'Passive Income',
                            data: data.passiveIncomeOverYears,
                            borderColor: 'purple',
                            backgroundColor: 'rgba(128, 0, 128, 0.1)',
                            fill: false,
                            type: 'line'
                        }, {
                            label: 'Lump Sum Changes',
                            data: lumpSumData,
                            borderColor: 'black',
                            backgroundColor: 'black',
                            pointRadius: 8,
                            pointStyle: 'cross',
                            showLine: false,
                            type: 'scatter'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Income and Expenses Over Years with Lump Sum Changes'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Amount ($)'
                                }
                            }
                        }
                    }
                }));
            }

            // Chart 5: Percentage Coverage Box Plot
            const chartContainer5 = document.createElement('div');
            chartContainer5.className = 'chart-container';
            chartContainer5.innerHTML = '<canvas id="coverageChart"></canvas>';
            resultsDiv.appendChild(chartContainer5);

            const ctx5 = document.getElementById('coverageChart').getContext('2d');

            // Calculate percentage covered for each year
            const percentageCoveredData = years.map(year => {
                const yearIdx = year - 1;
                const coverageData = data.netAssetIncomeOverYears.map((sim, simIdx) => {
                    const netAssetIncome = sim[yearIdx];
                    const passiveIncome = data.passiveIncomeOverYears[yearIdx];
                    const expenses = data.expensesOverYears[simIdx][yearIdx];
                    return ((netAssetIncome + passiveIncome) / expenses) * 100;
                });

                coverageData.sort((a, b) => a - b);

                return {
                    x: year,
                    min: ss.min(coverageData),
                    q1: ss.quantile(coverageData, 0.25),
                    median: ss.median(coverageData),
                    q3: ss.quantile(coverageData, 0.75),
                    max: ss.max(coverageData)
                };
            });

            charts.push(new Chart(ctx5, {
                type: 'boxplot',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Coverage Distribution',
                            data: percentageCoveredData,
                            backgroundColor: 'rgba(0, 123, 255, 0.5)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '100% Coverage',
                            type: 'line',
                            data: years.map(() => 100),
                            borderColor: 'green',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Percentage of Expenses Covered'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Percentage Covered (%)'
                            }
                        }
                    }
                }
            }));

            // === NEW CHARTS: Asset / Liability Breakdown ===
            if (data.assetValuesOverYears && data.assetValuesOverYears.length > 0) {
                const visibleIdxs = data.assetNames.map((n, i) => n !== 'General Cash' ? i : null).filter(i => i !== null);
                const NUM_ASSETS = visibleIdxs.length;
                // Median value for each asset per year
                const medianAssetValsByYear = Array.from({ length: NUM_YEARS }, (_, y) => {
                    return visibleIdxs.map(aIdx => {
                        const vals = data.assetValuesOverYears.map(sim => sim[y][aIdx]);
                        return ss.median(vals);
                    });
                });

                // ---- Grouped Bar Chart ----
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-container';
                barContainer.innerHTML = '<canvas id="assetBarChart"></canvas>';
                resultsDiv.appendChild(barContainer);
                const ctxBar = document.getElementById('assetBarChart').getContext('2d');

                const barDatasets = visibleIdxs.map((idx, ord) => {
                    const name = data.assetNames[idx];
                    const hue = (ord * 360 / NUM_ASSETS) % 360;
                    return {
                        label: name,
                        data: medianAssetValsByYear.map(row => row[ord]),
                        backgroundColor: `hsl(${hue},70%,50%)`
                    };
                });

                charts.push(new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: barDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Median Asset / Liability Values by Year'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: $${formatCurrency(ctx.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: false,
                                title: { display: true, text: 'Year' }
                            },
                            y: {
                                title: { display: true, text: 'Value ($)' },
                                ticks: {
                                    callback: (val) => '$' + formatCurrency(val)
                                }
                            }
                        }
                    }
                }));

                // ---- Pie Charts for Final Year ----
                const finalMedians = medianAssetValsByYear[NUM_YEARS - 1];
                const posIndices = finalMedians.map((v, i) => v > 0 ? i : -1).filter(i => i !== -1);
                const negIndices = finalMedians.map((v, i) => v < 0 ? i : -1).filter(i => i !== -1);

                function createPie(indices, titleText, canvasId) {
                    if (indices.length === 0) return;
                    const pieContainer = document.createElement('div');
                    pieContainer.className = 'chart-container';
                    pieContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                    resultsDiv.appendChild(pieContainer);
                    const ctxPie = document.getElementById(canvasId).getContext('2d');
                    const values = indices.map(i => Math.abs(finalMedians[i]));
                    const labels = indices.map(i => data.assetNames[visibleIdxs[i]]);
                    const pieColors = indices.map((_, idx) => `hsl(${(idx * 360 / indices.length) % 360},70%,50%)`);
                    charts.push(new Chart(ctxPie, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{ data: values, backgroundColor: pieColors }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: titleText }
                            }
                        }
                    }));
                }

                createPie(posIndices, 'Final Year Asset Allocation (Median)', 'assetPieChart');
                createPie(negIndices, 'Final Year Liability Allocation (Median)', 'liabilityPieChart');
            }
        }

        // Render tables
        function renderTable(data, title) {
            const resultsDiv = document.getElementById('results');

            const tableContainer = document.createElement('div');
            tableContainer.className = 'results-table';

            const titleElement = document.createElement('h3');
            titleElement.textContent = title;
            tableContainer.appendChild(titleElement);

            const table = document.createElement('table');

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            tableContainer.appendChild(table);
            resultsDiv.appendChild(tableContainer);
        }

        // Asset management functions
        function updateAssetsTable() {
            const tbody = document.getElementById('assets_body');
            tbody.innerHTML = '';

            assetList.forEach((asset, idx) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = asset.name;
                row.appendChild(nameCell);

                const valueCell = document.createElement('td');
                valueCell.textContent = `$${formatCurrency(asset.value)}`;
                row.appendChild(valueCell);

                const meanCell = document.createElement('td');
                meanCell.textContent = asset.mean.toFixed(3);
                row.appendChild(meanCell);

                const sdCell = document.createElement('td');
                sdCell.textContent = asset.sd.toFixed(3);
                row.appendChild(sdCell);

                const actionCell = document.createElement('td');
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '-';
                removeBtn.onclick = () => removeAsset(idx);
                actionCell.appendChild(removeBtn);
                row.appendChild(actionCell);

                tbody.appendChild(row);
            });
        }

        function addAsset() {
            const name = document.getElementById('asset_name').value.trim();
            const value = parseFloat(stripCommas(document.getElementById('asset_value').value)) || 0;
            const mean = parseFloat(document.getElementById('asset_ret_mean').value) || 0;
            const sd = parseFloat(document.getElementById('asset_ret_sd').value) || 0;

            const errorEl = document.getElementById('asset_error');
            let errorMessage = '';

            if (!name) {
                errorMessage = 'Name is required.';
            } else if (value <= 0) {
                errorMessage = 'Value must be positive.';
            } else if (mean === 0) {
                errorMessage = 'Expected return mean cannot be 0 (positive or negative allowed).';
            } else if (sd <= 0) {
                errorMessage = 'Expected return SD must be positive.';
            }

            if (errorMessage) {
                errorEl.textContent = errorMessage;
                return;
            } else {
                errorEl.textContent = '';
            }

            assetList.push({ name, value, mean, sd });
            updateAssetsTable();

            // Clear inputs
            document.getElementById('asset_name').value = '';
            document.getElementById('asset_value').value = '';
            document.getElementById('asset_ret_mean').value = '';
            document.getElementById('asset_ret_sd').value = '';
        }

        function removeAsset(idx) {
            if (idx >= 0 && idx < assetList.length) {
                assetList.splice(idx, 1);
                updateAssetsTable();
            }
        }

        // Lump sum management functions
        function updateLumpSumsTable() {
            const tbody = document.getElementById('lump_sums_body');
            tbody.innerHTML = '';

            Array.from(lumpSums.entries())
                .sort(([a], [b]) => a - b)
                .forEach(([year, amount]) => {
                    const row = document.createElement('tr');

                    const yearCell = document.createElement('td');
                    yearCell.textContent = year.toString();
                    row.appendChild(yearCell);

                    const amountCell = document.createElement('td');
                    amountCell.textContent = `$${formatCurrency(amount)}`;
                    row.appendChild(amountCell);

                    const actionCell = document.createElement('td');
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.onclick = () => removeLumpSum(year);
                    actionCell.appendChild(removeBtn);
                    row.appendChild(actionCell);

                    tbody.appendChild(row);
                });
        }

        function addLumpSum() {
            const year = parseInt(document.getElementById('lump_year').value);
            const amount = parseFloat(stripCommas(document.getElementById('lump_amount').value)) || 0;
            const maxYears = parseInt(document.getElementById('years').value);

            if (year < 1 || year > maxYears) {
                return;
            }

            lumpSums.set(year, amount);
            updateLumpSumsTable();

            // Clear inputs
            document.getElementById('lump_year').value = '1';
            document.getElementById('lump_amount').value = '0';
        }

        function removeLumpSum(year) {
            lumpSums.delete(year);
            updateLumpSumsTable();
        }

        // PDF Export function
        async function exportToPDF() {
            const exportBtn = document.getElementById('export_pdf');
            exportBtn.style.display = 'none';

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Add title
            pdf.setFontSize(20);
            pdf.text("Financial Simulation Report", 20, 20);

            // Add timestamp
            pdf.setFontSize(10);
            const timestamp = new Date().toLocaleString();
            pdf.text(`Generated on: ${timestamp}`, 20, 30);

            // Add input parameters
            pdf.setFontSize(12);
            pdf.text("Simulation Parameters:", 20, 45);

            let yPosition = 55;
            const { params } = parseInputs();

            for (const [key, value] of Object.entries(params)) {
                let displayValue = value;
                if (typeof value === 'number' && !Number.isInteger(value)) {
                    displayValue = value.toFixed(2);
                }
                pdf.setFontSize(10);
                pdf.text(`${key}: ${displayValue}`, 25, yPosition);
                yPosition += 7;
            }

            // Add lump sums
            yPosition += 10;
            pdf.setFontSize(12);
            pdf.text("Lump Sums:", 20, yPosition);
            yPosition += 10;

            if (lumpSums.size > 0) {
                pdf.setFontSize(10);
                for (const [year, amount] of Array.from(lumpSums.entries()).sort(([a], [b]) => a - b)) {
                    pdf.text(`Year ${year}: $${formatCurrency(amount)}`, 25, yPosition);
                    yPosition += 7;
                }
            } else {
                pdf.text("No lump sums defined", 25, yPosition);
                yPosition += 7;
            }

            // Add charts and tables
            const resultsDiv = document.getElementById('results');

            // Convert each chart to canvas and add to PDF
            for (const canvas of resultsDiv.querySelectorAll('canvas')) {
                pdf.addPage();
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 20, 20, 170, 100);
            }

            // Add tables
            for (const table of resultsDiv.querySelectorAll('table')) {
                pdf.addPage();
                const canvas = await html2canvas(table);
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 20, 20, 170, 100);
            }

            // Save the PDF
            pdf.save('financial_simulation_report.pdf');

            // Show the export button again
            exportBtn.style.display = 'inline-block';
        }

        // Main simulation runner
        async function runSim() {
            const runButton = document.getElementById('run');
            runButton.textContent = 'Simulating...';
            runButton.disabled = true;

            // Clear previous results
            document.getElementById('results').innerHTML = '';

            try {
                // Small delay to allow UI to update
                await new Promise(resolve => setTimeout(resolve, 10));

                const { params, lumpSums: lumpSumChanges } = parseInputs();
                const simData = runSimulation(params, lumpSumChanges);

                // Generate and display results table
                const resultsTable = generateResultsTable(simData);
                renderTable(resultsTable, 'Simulation Results by Year');

                // Calculate and display statistics
                const stats = calculateEndStats(simData, params);
                const statsTable = Object.entries(stats).map(([key, value]) => ({
                    Insight: key,
                    Value: value
                }));
                renderTable(statsTable, 'Key Insights');

                // Create charts
                createCharts(simData, params);

                // Show export button
                document.getElementById('export_pdf').style.display = 'inline-block';

            } catch (error) {
                console.error('Simulation error:', error);
                document.getElementById('results').innerHTML = `<div style="color: red; padding: 20px;">Error running simulation: ${error.message}</div>`;
            } finally {
                runButton.textContent = 'Run Simulation';
                runButton.disabled = false;
            }
        }

        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function () {
            // Asset management
            document.getElementById('add_asset').addEventListener('click', addAsset);

            // Lump sum management
            document.getElementById('add_lump_sum').addEventListener('click', addLumpSum);

            // Main simulation
            document.getElementById('run').addEventListener('click', runSim);

            // PDF export
            document.getElementById('export_pdf').addEventListener('click', exportToPDF);

            // Toggle sections
            document.getElementById('toggle_assets').addEventListener('click', function () {
                const section = document.getElementById('assets_section');
                const button = this;
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    button.textContent = '-';
                } else {
                    section.style.display = 'none';
                    button.textContent = '+';
                }
            });

            document.getElementById('toggle_lumps').addEventListener('click', function () {
                const section = document.getElementById('lump_section');
                const button = this;
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    button.textContent = '-';
                } else {
                    section.style.display = 'none';
                    button.textContent = '+';
                }
            });

            // Modal functionality
            const instructionsModal = document.getElementById('instructionsModal');
            const fevModal = document.getElementById('fevModal');
            const cardModal = document.getElementById('cardInfoModal');

            document.getElementById('openInstructions').addEventListener('click', () => {
                instructionsModal.style.display = 'block';
            });

            document.getElementById('openFEV').addEventListener('click', () => {
                fevModal.style.display = 'block';
            });

            document.getElementById('closeInstructions').addEventListener('click', () => {
                instructionsModal.style.display = 'none';
            });

            document.getElementById('closeFEV').addEventListener('click', () => {
                fevModal.style.display = 'none';
            });

            document.getElementById('closeCardInfo').addEventListener('click', () => {
                cardModal.style.display = 'none';
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === instructionsModal) instructionsModal.style.display = 'none';
                if (e.target === fevModal) fevModal.style.display = 'none';
                if (e.target === cardModal) cardModal.style.display = 'none';
            });

            // Info button functionality
            const infoContent = {
                general: `<h2>General Parameters</h2><p>These parameters control the overall simulation length and randomness.</p><ul><li><b>Random Seed</b>: ensures repeatable runs.</li><li><b>Years</b>: duration of the simulation. Could also be months - adjust other parameters accordingly</li><li><b>Simulations</b>: number of Monte Carlo trials to run.</li><li><b>Tax Rate</b>: percentage applied to capital gains when assets are sold.</li><li><b>Inflation</b>: annual increase applied to expenses.</li><li><b>Depletion Threshold</b>: asset level considered "out of money".</li><li><b>Excess Cash Goes To</b>: assets or liabilities. If you have extra cash at the end of each year, do you pay down debt or invest?</li></ul>`,
                assets: `<h2>Assets</h2><p>Add each investable asset you own.</p><ul><li><b>Name</b>: descriptive label.</li><li><b>Value ($)</b>: current market value.</li><li><b>Expected Return Mean (decimal)</b>: average annual return.</li><li><b>Expected Return SD (%)</b>: annual volatility.</li></ul><p>The simulator automatically computes a weighted portfolio return and volatility.</p>`,
                active: `<h2>Active Income</h2><p>Your employment or business income.</p><ul><li><b>Active Income ($)</b>: after-tax annual pay.</li><li><b>Active Income Growth Rate (%)</b>: expected yearly raises.</li><li><b>Years to Work</b>: number of years this income is earned.</li></ul>`,
                passive: `<h2>Passive Income</h2><p>Recurring income streams such as pensions, Social Security, or rental income.</p><ul><li><b>Additional Passive Income ($)</b>: current annual amount.</li><li><b>Passive Income Growth Rate (%)</b>: expected yearly change (can be negative).</li></ul>`,
                expenses: `<h2>Expenses</h2><p>Annual living costs and their variability.</p><ul><li><b>Expected Expenses Mean ($)</b>: typical yearly spending.</li><li><b>Expected Expenses SD ($)</b>: variability of that spending.</li><li><b>Unexpected Expense Chance (%)</b>: probability of a surprise expense each year.</li><li><b>Unexpected Expense Amount ($)</b>: size of that surprise cost.</li></ul>`,
                lumps: `<h2>Lump Sums</h2><p>Add one-off future cash flows.</p><ul><li><b>Year</b>: simulation year (1-n).</li><li><b>Amount ($)</b>: positive for income, negative for expenses.</li></ul>`,
                liabilities: `<h2>Liabilities</h2><p>Add each debt you hold (credit cards, loans, mortgage).</p><ul><li><b>Name</b>: descriptive label.</li><li><b>Amount ($)</b>: outstanding balance (enter positive amount).</li><li><b>Expected Interest Mean (%)</b>: average annual interest rate (positive amount).</li><li><b>Interest SD (%)</b>: volatility of that rate.</li></ul>`
            };

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const key = btn.getAttribute('data-info');
                    document.getElementById('cardInfoBody').innerHTML = infoContent[key] || '';
                    cardModal.style.display = 'block';
                });
            });

            // Number formatting for currency inputs
            function addFormatListeners(input) {
                input.addEventListener('focus', function () {
                    input.value = input.value.replace(/,/g, '');
                });
                input.addEventListener('blur', function () {
                    if (input.value !== '') {
                        const num = Number(input.value.replace(/,/g, ''));
                        if (!isNaN(num)) {
                            input.value = num.toLocaleString('en-US');
                        }
                    }
                });
            }

            document.querySelectorAll('input.format-number').forEach(addFormatListeners);

            // Register boxplot / violin controllers for @sgratzl/chartjs-chart-boxplot (needed for Chart.js v4)
            if (Chart.BoxPlotController && !Chart.registry.controllers.get('boxplot')) {
                Chart.register(
                    Chart.BoxPlotController,
                    Chart.ViolinPlotController || Chart.ViolinController || Chart.Violin,
                    Chart.BoxPlotElement || Chart.BoxAndWhiskers,
                    Chart.ViolinPlotElement || Chart.Violin
                );
            }

            // Liability management
            document.getElementById('add_liability').addEventListener('click', addLiability);

            document.getElementById('toggle_liabilities').addEventListener('click', function () {
                const section = document.getElementById('liabilities_section');
                const button = this;
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    button.textContent = '-';
                } else {
                    section.style.display = 'none';
                    button.textContent = '+';
                }
            });
        });

        function updateLiabilitiesTable() {
            const tbody = document.getElementById('liabilities_body');
            if (!tbody) return;
            tbody.innerHTML = '';
            liabilityList.forEach((liab, idx) => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = liab.name;
                row.appendChild(nameCell);
                const valueCell = document.createElement('td');
                valueCell.textContent = `$${formatCurrency(-liab.value)}`; // display positive
                row.appendChild(valueCell);
                const meanCell = document.createElement('td');
                meanCell.textContent = liab.mean.toFixed(3);
                row.appendChild(meanCell);
                const sdCell = document.createElement('td');
                sdCell.textContent = liab.sd.toFixed(3);
                row.appendChild(sdCell);
                const actionCell = document.createElement('td');
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '-';
                removeBtn.onclick = () => removeLiability(idx);
                actionCell.appendChild(removeBtn);
                row.appendChild(actionCell);
                tbody.appendChild(row);
            });
        }

        function addLiability() {
            const name = document.getElementById('liability_name').value.trim();
            const value = parseFloat(stripCommas(document.getElementById('liability_value').value)) || 0;
            const mean = parseFloat(document.getElementById('liability_ret_mean').value) || 0;
            const sd = parseFloat(document.getElementById('liability_ret_sd').value) || 0;
            const errorEl = document.getElementById('liability_error');
            let errorMessage = '';
            if (!name) {
                errorMessage = 'Name is required.';
            } else if (value <= 0) {
                errorMessage = 'Amount must be positive.';
            } else if (sd < 0) {
                errorMessage = 'SD must be non-negative.';
            }
            if (errorMessage) { errorEl.textContent = errorMessage; return; } else { errorEl.textContent = ''; }
            liabilityList.push({ name, value: -Math.abs(value), mean, sd });
            updateLiabilitiesTable();
            document.getElementById('liability_name').value = '';
            document.getElementById('liability_value').value = '';
            document.getElementById('liability_ret_mean').value = '';
            document.getElementById('liability_ret_sd').value = '';
        }

        function removeLiability(idx) {
            if (idx >= 0 && idx < liabilityList.length) {
                liabilityList.splice(idx, 1);
                updateLiabilitiesTable();
            }
        }

    </script>
</body>

</html>
