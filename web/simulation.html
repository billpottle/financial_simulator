<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Financial Simulator - JavaScript</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.1/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.4.4/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/seedrandom.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color: #333;
            --muted-text-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            font-weight: 700;
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .section-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 35px 50px 30px 50px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 32px 32px;
            margin-bottom: 24px;
        }

        .section-card+.section-card {
            margin-top: 40px;
        }

        label>input {
            margin-top: 6px;
        }

        .lump-sum-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 32px;
            align-items: end;
        }

        label {
            display: flex;
            flex-direction: column;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .button-container {
            margin: 30px 0;
        }

        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #a0a0a0;
        }

        #add_asset,
        #toggle_assets,
        #toggle_lumps {
            padding: 10px;
            font-size: 18px;
            min-width: 42px;
            align-self: end;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        th,
        td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 700;
            color: var(--muted-text-color);
            font-size: 12px;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        td button {
            background-color: var(--danger-color);
        }

        td button:hover {
            background-color: #a71d2a;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-content pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .assets-input-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr) auto;
            gap: 32px;
            align-items: end;
            margin-bottom: 24px;
        }

        .info-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background-color: transparent;
            color: var(--primary-color);
        }

        .info-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-wrap: wrap; 
            gap: 16px; 
            margin-bottom: 30px; 
        }
        
        .header-buttons button { 
            margin-left: 10px; 
        }

        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .results-table {
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            background-color: var(--background-color);
            font-weight: 600;
        }

        /* Keep label text on its own line, wrap if necessary,
           but prevent the input from being pushed too far down */
        label span {
            display:block;            /* forces label text onto its own line */
            line-height:1.2;          /* tighter text so cell height stays reasonable */
            margin-bottom:4px;        /* breathing room above the input */
            white-space:normal;       /* let it wrap instead of widening the grid cell */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Financial Simulator</h1>
            <div class="header-buttons">
                <button id="openInstructions" style="font-size: 14px; font-weight: 500;">Interpreting Results</button>
                <button id="openFEV" style="font-size: 14px; font-weight: 500;">What is FEV?</button>
            </div>
        </div>

        <div class="section-card">
            <h3>Quick Start</h3>
            <p>It would be trivial to make the best financial decisions if you had a crystal ball that could tell you the
                rate of return every asset would get every year,
                every time an unexpected expense would pop up, etc. While we don't have a crystal ball, we can do much
                better than just <b>random guessing</b> because we do have <b>historical statistics</b> about how certain assset
                classes have performed in the past. </p>
                <p>
                For instance, the SP500 has historically returned about 10.5% per year with a standard deviation of
                18.5%. This means each year there is a 68% chance that the return will be between -8.0% and 29.0%.
                This program runs many simulations of your financial future, and then does statistics on the results.
            </p>
    <hr />
            <p>
                Most people would vary the input parameters and run multiple simulations. This could help you answer
                questions like:
            <ul></ul>
            <li>How many years will you need to work?</li>
            <li>How sensitive is your situation to unexpected expenses?</li>
            <li>How will refinancing your mortgage today affect your future 10 years from now?</li>
            <li>How much you will be able to afford to contribute to children's college expenses in 12 years?</li>
            <li>How will the composition of your portfolio change over time as different assets have different returns?</li>
            <li>How will your situation change with 3% vs 5% inflation?</li>
            </ul>
            </p>
            <p>Click on the info button next to each section to see important details and caveats</p>
        </div>

        <div class="section-card">
            <h3>General Parameters <button class="info-btn" data-info="general">ℹ️</button></h3>
            <div class="input-grid">
                <label>Random Seed <input id="seed" type="number" value="42"></label>
                <label>Years <input id="years" type="number" value="20"></label>
                <label>Simulations <input id="sims" type="number" value="100"></label>
                <label>Tax Rate (% as decimal) <input id="tax_rate" type="number" value="0.2" step="0.01"></label>
                <label>Inflation (% as decimal) <input id="inflation" type="number" value="0.03" step="0.01"></label>
                <label>Depletion Threshold ($) <input id="depletion" class="format-number" type="text"
                        value="20000"></label>
                <label>Excess Cash Goes To
                    <select id="cash_target">
                        <option value="assets" selected>Assets</option>
                        <option value="liabilities">Liabilities</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="section-card">
            <h3>Assets <button class="info-btn" data-info="assets">ℹ️</button><button id="toggle_assets"
                    style="margin-left:auto;">+</button></h3>
            <div id="assets_section" style="display:none;">
                <!-- Input row for creating a new asset -->
                <div class="assets-input-row">
                    <label>Name <input id="asset_name" type="text" placeholder="e.g. Index Fund"></label>
                    <label>Value ($) <input id="asset_value" class="format-number" type="text"
                            placeholder="100,000"></label>
                    <label>Expected Return Mean (% as decimal) <input id="asset_ret_mean" type="number" step="0.001"
                            placeholder="0.07"></label>
                    <label>Expected Return SD (% as decimal) <input id="asset_ret_sd" type="number" step="0.001"
                            placeholder="0.15"></label>
                    <button id="add_asset" class="icon-btn">+</button>
                </div>

                <!-- Table displaying current assets -->
                <div id="assets_table_container" style="margin-top: 10px;">
                    <table id="assets_table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Value ($)</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Mean %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">SD %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="assets_body"></tbody>
                    </table>
                </div>

                <!-- Error message for asset input -->
                <div id="asset_error" style="color: red; margin-top: 5px;"></div>
            </div> <!-- End assets_section -->
        </div>

        <div class="section-card">
            <h3>Liabilities <button class="info-btn" data-info="liabilities">ℹ️</button><button id="toggle_liabilities" style="margin-left:auto;">+</button></h3>
            <div id="liabilities_section" style="display:none;">
                <div class="assets-input-row"> <!-- reuse grid style -->
                    <label>Name <input id="liability_name" type="text" placeholder="e.g. Credit Card"></label>
                    <label>Amount ($) <input id="liability_value" class="format-number" type="text" placeholder="20,000"></label>
                    <label>Expected Interest Mean (% as decimal) <input id="liability_ret_mean" type="number" step="0.001" placeholder="-0.15"></label>
                    <label>Interest SD (% as decimal) <input id="liability_ret_sd" type="number" step="0.001" placeholder="0.05"></label>
                    <button id="add_liability" class="icon-btn">+</button>
                </div>
                <div id="liabilities_table_container" style="margin-top:10px;">
                    <table style="width:100%; border-collapse:collapse;" id="liabilities_table">
                        <thead>
                            <tr>
                                <th>Name</th><th>Amount ($)</th><th>Mean %</th><th>SD %</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="liabilities_body"></tbody>
                    </table>
                </div>
                <div id="liability_error" style="color:red; margin-top:5px;"></div>
            </div>
        </div>

        <div class="section-card">
            <h3>Active Income <button class="info-btn" data-info="active">ℹ️</button></h3>
            <div class="input-grid">
                <label>Active Income ($) <input id="active_income" class="format-number" type="text"
                        value="65000"></label>
                <label>Growth Rate (% as decimal) <input id="active_growth" type="number" value="0.02"
                        step="0.01"></label>
                <label>Years to Work <input id="years_work" type="number" value="15"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Passive Income <button class="info-btn" data-info="passive">ℹ️</button></h3>
            <div class="input-grid">
                <label>Additional Passive Income ($) <input id="passive_income" class="format-number" type="text"
                        value="5000"></label>
                <label>Growth Rate (% as decimal) <input id="passive_growth" type="number" value="0.02"
                        step="0.01"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Expenses <button class="info-btn" data-info="expenses">ℹ️</button></h3>
            <div class="input-grid">
                <label>Expected Expenses Mean ($) <input id="exp_mean" class="format-number" type="text"
                        value="50000"></label>
                <label>Expected Expenses SD ($) <input id="exp_sd" class="format-number" type="text"
                        value="10000"></label>
                <label>Chance Per Year  (% as decimal) <input id="unexpected_chance" type="number" value="0.15"
                        step="0.01"></label>
                <label>Unexpected Expense Amount ($) <input id="unexpected_amount" class="format-number" type="text"
                        value="10000"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Lump Sums <button class="info-btn" data-info="lumps">ℹ️</button><button id="toggle_lumps"
                    style="margin-left:auto;">+</button></h3>
            <div id="lump_section" style="display:none;">
                <div class="lump-sum-input-row">
                    <label>Year <input id="lump_year" type="number" min="1" value="1"></label>
                    <label>Amount ($) <input id="lump_amount" class="format-number" type="text" value="0"></label>
                    <button id="add_lump_sum" class="icon-btn">+</button>
                </div>
                <div id="lump_sums_table_container" style="margin-top: 20px;">
                    <table id="lump_sums_table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="lump_sums_body">
                        </tbody>
                    </table>
                </div>
            </div> <!-- end lump_section -->
        </div>

        <div class="button-container">
            <button id="run">Run Simulation</button>
            <button id="export_pdf" style="display: none;">Export to PDF</button>
        </div>

        <div id="results"></div>

        <!-- Instructions Modal -->
        <div id="instructionsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeInstructions">&times;</span>
                <h2>Financial Simulator - Intrepreting Results</h2>
                <p><em>"It's hard to make predictions – especially about the future." – Yogi Berra</em></p>

                <h3>How It Works</h3>
                <p>The simulator performs many Monte Carlo trials (&ldquo;Simulations&rdquo;) using the parameters you
                    provide. Each trial randomly samples investment returns, inflation, and expenses to create a
                    possible future trajectory for your finances. Results are aggregated to show medians, distributions,
                    and probabilities.</p>

                <p><b>Medians</b> show the value where half of the simulations came in above and half are below. 
                this is similar to the <b>average</b>, but averages can be more skewed by extreme high or low values (outliers). </p>

                <p><b>Probabilities</b> give the chance of a certain outcome happening. For instance, you might be considering whether to take on a certain monthly
                expense. The simulator could tell you if it increased your chance of running out of money from 5% to 12%. Similarly, perhaps working 1 more year
            increases your chance of achieving FEV from 10% to 30%. </p>

            <p><b>Distributions</b> show how the probabilities are spread through most outcomes. Normal distributions are assumed for most of this modeling. 
                For instance, the box plot shows the median, the 25th and 75th percentiles, and the 10th and 90th percentiles. 
             </p>
               
                <h3>Interpreting Results</h3>
                <p>After running, you&rsquo;ll receive:</p>
                <ul>
                    <li><b>Median Trajectories &amp; Box Plots</b> for investable assets.</li>
                    <li><b>Income vs. Expenses</b> charts.</li>
                    <li><b>Key Insights</b> table – chance of depletion, chance of achieving FEV, etc.</li>
                </ul>
                <p> The key insights table gives you a high level overview of the results. </p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/key_insights.jpg"
                    alt="Key Insights" style="max-width: 100%; margin: 10px 0;" />
                    <p> The summary table shows the median values for each year. Remember, assets are only sold and 
                        capital gains taxes are only paid when expenses cannot be covered by active income alone. </p>   
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/table1.png"
                    alt="Summary Table" style="max-width: 100%; margin: 10px 0;" />
                    <p> The assets over years graph shows how your net worth changed over time. Each line represents a different simulation.
                        Results are clustered closer together at the beginning and spread out over time. </p>  
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/assets_over_years.jpg"
                    alt="Assets Over Years" style="max-width: 100%; margin: 10px 0;" />
                    <p> This is the same information but in box plot format</p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/assets_over_time.png?raw=true" alt="Asset Allocation Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p> The median asset allocation over time shows how the values of your assets and liabilities have changed over years.</p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/asset_allocation_over_time.png?raw=true" alt="Assets Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p> The ending assets graph shows the distribution of the final net worth for each simulation. </p>
                <img src="https://github.com/billpottle/financial_simulator/blob/main/ending_assets.png?raw=true" alt="Ending Assets" style="max-width: 100%; margin: 10px 0;" />

            </div>
        </div>

        <!-- Card Info Modal -->
        <div id="cardInfoModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeCardInfo">&times;</span>
                <div id="cardInfoBody"></div>
            </div>
        </div>

        <!-- FEV Modal -->
        <div id="fevModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeFEV">&times;</span>
                <h2>Financial Escape Velocity (FEV)</h2>
                <p>This is a graph of net worth over time for a typical person. Generally, their net worth will increase
                    until they retire, but then it will decrease as they start to spend down their assets. The question of
                    retirement becomes "will I run out of money before I die?"</p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/net_worth_over_time.png"
                    alt="Net Worth Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p></p> Another, related but more difficult goal to achieve is what I call <b>'Financial Escape
                    Velocity'</b>, or being able to increase your net worth through passive and investment income. This
                is similar to how a rocket needs to reach a certain speed to escape Earth's gravity - once achieved, the
                momentum becomes self-sustaining. Those who achieve FEV will generally have their net worth
                <em>increase</em>
                with age. </p>
                <p>Imagine - if your income is $1,000 / month in retirement - if you spend $1,001 per month, eventually
                    you will run out of money. However, if you spend $999 per month, you will increase your assets each
                    month.</p>

                <p>The simulator looks across every single Monte-Carlo trial and flags the first year where:</p>
                <ul>
                    <li>Passive&nbsp;Income&nbsp;+ Median&nbsp;Asset&nbsp;Return ≥ Expenses</li>
                    <li>and the <em>cumulative</em> income after that point continues to outpace cumulative expenses.
                    </li>
                </ul>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/fev_graph.jpg"
                    alt="FEV graph" style="max-width: 100%; margin: 10px 0;" />


                <p>The green line represents covering 100% of your expenses with passive and investment income. The box plots show the distribution of times that it happened. 
                    For instance, if the lower 'wisker' of the box plot is over the green line, you have a 90% chance of covering all your expenses that year. 
                </p>
            </div>
        </div>
    </div>

    <!-- Load main JS (no module type to avoid CORS issues when running via file://) -->
    <script src="simulation.js"></script>
</body>

</html>
