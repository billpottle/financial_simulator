<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Simulator - PyScript</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(250px,1fr)); gap: 10px; }
        label { display:block; font-weight:bold; }
        input { width: 100%; }
        #results img { max-width: 100%; }
        .button-container { margin: 20px 0; }
        .button-container button { margin-right: 10px; }
        
        /* Loading bar styles */
        .loading-container {
            display: inline-block;
            min-width: 200px;
        }
        .loading-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        .loading-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            height: 100%;
            width: 100%;
            background-color: #4CAF50;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 2px;
        }
        .loading-text {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #2196F3;
            transition: width 0.3s ease-in-out;
            border-radius: 2px;
        }
        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1>Financial Simulator</h1>

<div class="input-grid">
<label>Random Seed <input id="seed" type="number" value="42"></label>
<label>Years <input id="years" type="number" value="20"></label>
<label>Simulations <input id="sims" type="number" value="100"></label>
<label>Investable Assets <input id="assets" type="number" value="100000"></label>
<label>Expected Return Mean (%) <input id="ret_mean" type="number" value="11.88"></label>
<label>Expected Return SD (%) <input id="ret_sd" type="number" value="15"></label>
<label>Tax Rate <input id="tax_rate" type="number" value="0.2" step="0.01"></label>
<label>Expected Expenses Mean <input id="exp_mean" type="number" value="50000"></label>
<label>Expected Expenses SD <input id="exp_sd" type="number" value="10000"></label>
<label>Inflation <input id="inflation" type="number" value="0.03" step="0.01"></label>
<label>Additional Passive Income <input id="passive_income" type="number" value="5000"></label>
<label>Passive Income Growth Rate <input id="passive_growth" type="number" value="0.02" step="0.01"></label>
<label>Active Income <input id="active_income" type="number" value="65000"></label>
<label>Active Income Growth Rate <input id="active_growth" type="number" value="0.02" step="0.01"></label>
<label>Years to Work <input id="years_work" type="number" value="15"></label>
<label>Unexpected Expense Chance <input id="unexpected_chance" type="number" value="0.15" step="0.01"></label>
<label>Unexpected Expense Amount <input id="unexpected_amount" type="number" value="10000"></label>
<label>Depletion Threshold <input id="depletion" type="number" value="20000"></label>
</div>

<div id="lump-sums-section">
    <h3>Lump Sums</h3>
    <div class="input-grid" style="grid-template-columns: auto auto auto;">
        <label>Year <input id="lump_year" type="number" min="1" value="1"></label>
        <label>Amount ($) <input id="lump_amount" type="number" value="0"></label>
        <button id="add_lump_sum" py-click="add_lump_sum">Add Lump Sum</button>
    </div>
    <div id="lump_sums_table_container" style="margin-top: 10px;">
        <table id="lump_sums_table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">Year</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Action</th>
                </tr>
            </thead>
            <tbody id="lump_sums_body">
            </tbody>
        </table>
    </div>
</div>

<div class="button-container">
    <div id="initial-loading" class="loading-container">
        <div class="loading-bar"></div>
        <div class="loading-text">Loading Python dependencies...</div>
    </div>
    <button id="run" py-click="run_sim" style="display: none;">Run Simulation</button>
    <button id="export_pdf" py-click="export_to_pdf" style="display: none;">Export to PDF</button>
</div>

<div id="simulation-progress" class="loading-container" style="display: none;">
    <div class="progress-bar">
        <div class="progress-bar-fill" style="width: 0%"></div>
    </div>
    <div class="progress-text">Preparing simulation...</div>
</div>

<div id="results"></div>

<py-config>
packages = ["numpy", "pandas", "matplotlib"]
</py-config>

<py-script>
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from js import document, window
from pyscript import display
from pyodide.ffi import create_proxy

def check_page_ready():
    # Check if the Add Lump Sum button is available and not disabled
    add_button = document.getElementById('add_lump_sum')
    if add_button and not add_button.disabled:
        # Page is fully ready, stop the spinner and show run button
        initial_loading = document.getElementById('initial-loading')
        run_button = document.getElementById('run')
        if initial_loading and run_button:
            # Remove the loading animation
            loading_bar = initial_loading.querySelector('.loading-bar')
            if loading_bar:
                loading_bar.style.animation = 'none'
            initial_loading.style.display = 'none'
            run_button.style.display = 'inline-block'
    else:
        # Check again in a short while
        window.setTimeout(create_proxy(check_page_ready), 100)

# Start checking for page readiness
check_page_ready()

def update_simulation_progress(current, total):
    progress_container = document.getElementById('simulation-progress')
    progress_bar = progress_container.querySelector('.progress-bar-fill')
    progress_text = progress_container.querySelector('.progress-text')
    
    percentage = (current / total) * 100
    progress_bar.style.width = f"{percentage}%"
    progress_text.textContent = f"Running simulation {current} of {total}..."

# Store lump sums in a global variable
lump_sum_changes = {}

def add_lump_sum(event=None):
    year = int(document.getElementById('lump_year').value)
    amount = float(document.getElementById('lump_amount').value)
    max_years = int(document.getElementById('years').value)
    
    if year < 1 or year > max_years:
        return
    
    lump_sum_changes[year] = amount
    update_lump_sums_table()
    
    # Clear the input fields
    document.getElementById('lump_year').value = "1"
    document.getElementById('lump_amount').value = "0"

def remove_lump_sum(year, event=None):
    # Convert year to int to ensure we're using a hashable type
    year_int = int(year)
    if year_int in lump_sum_changes:
        del lump_sum_changes[year_int]
        update_lump_sums_table()

def update_lump_sums_table():
    tbody = document.getElementById('lump_sums_body')
    tbody.innerHTML = ''
    
    for year in sorted(lump_sum_changes.keys()):
        amount = lump_sum_changes[year]
        row = document.createElement('tr')
        
        # Year cell
        year_cell = document.createElement('td')
        year_cell.style.border = '1px solid #ddd'
        year_cell.style.padding = '8px'
        year_cell.textContent = str(year)
        row.appendChild(year_cell)
        
        # Amount cell
        amount_cell = document.createElement('td')
        amount_cell.style.border = '1px solid #ddd'
        amount_cell.style.padding = '8px'
        amount_cell.textContent = f"${amount:,.2f}"
        row.appendChild(amount_cell)
        
        # Remove button cell
        button_cell = document.createElement('td')
        button_cell.style.border = '1px solid #ddd'
        button_cell.style.padding = '8px'
        remove_button = document.createElement('button')
        remove_button.textContent = 'Remove'
        # Store the year as a data attribute and use a regular function
        remove_button.setAttribute('data-year', str(year))
        remove_button.onclick = lambda e: remove_lump_sum(e.target.getAttribute('data-year'))
        button_cell.appendChild(remove_button)
        row.appendChild(button_cell)
        
        tbody.appendChild(row)

def parse_inputs():
    get_val = lambda i: document.getElementById(i).value
    data = {
        'Random Seed': int(get_val('seed')),
        'Years': int(get_val('years')),
        'Simulations': int(get_val('sims')),
        'Investable Assets': float(get_val('assets')),
        'Expected Return Mean': float(get_val('ret_mean')),
        'Expected Return SD': float(get_val('ret_sd')),
        'Tax Rate': float(get_val('tax_rate')),
        'Expected Expenses Mean': float(get_val('exp_mean')),
        'Expected Expenses SD': float(get_val('exp_sd')),
        'Inflation': float(get_val('inflation')),
        'Additional Passive Income': float(get_val('passive_income')),
        'Passive Income Growth Rate': float(get_val('passive_growth')),
        'Active Income': float(get_val('active_income')),
        'Active Income Growth Rate': float(get_val('active_growth')),
        'Years to Work': int(get_val('years_work')),
        'Unexpected Expense Chance': float(get_val('unexpected_chance')),
        'Unexpected Expense Amount': float(get_val('unexpected_amount')),
        'Depletion Threshold': float(get_val('depletion'))
    }
    return data, lump_sum_changes


# Simulation functions adapted from simulation.py

def run_simulation(params, lump_sum_changes):
    np.random.seed(int(params['Random Seed']))
    NUM_SIMULATIONS = int(params['Simulations'])
    NUM_YEARS = int(params['Years'])
    initial_investable_assets = params['Investable Assets']
    expected_annual_return = params['Expected Return Mean']
    expected_annual_volatility = params['Expected Return SD']
    initial_yearly_expenses = params['Expected Expenses Mean']
    expenses_volatility = params['Expected Expenses SD']
    inflation = params['Inflation']
    unexpected_expense_chance = params['Unexpected Expense Chance']
    unexpected_expense_amount = params['Unexpected Expense Amount']
    passive_income = params['Additional Passive Income']
    years_to_work = params['Years to Work']
    active_income = params['Active Income']
    tax_rate = params['Tax Rate']
    active_income_growth_rate = params['Active Income Growth Rate']
    passive_income_growth_rate = params['Passive Income Growth Rate']
    depletion_threshold = params['Depletion Threshold']

    assets_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
    net_asset_income_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
    expenses_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
    taxes_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
    unexpected_expenses_over_years = np.zeros(NUM_YEARS)

    active_income_over_years = []
    for year in range(NUM_YEARS):
        if year < years_to_work:
            income_for_year = active_income * (1 + active_income_growth_rate) ** year
            active_income_over_years.append(income_for_year)
        else:
            active_income_over_years.append(0)
    active_income_over_years = np.array(active_income_over_years)

    passive_income_over_years = []
    for year in range(NUM_YEARS):
        passive_income_for_year = passive_income * (1 + passive_income_growth_rate) ** year
        passive_income_over_years.append(passive_income_for_year)
    passive_income_over_years = np.array(passive_income_over_years)

    for sim in range(NUM_SIMULATIONS):
        # Update progress
        update_simulation_progress(sim + 1, NUM_SIMULATIONS)
        
        assets = initial_investable_assets
        for year in range(NUM_YEARS):
            if year + 1 in lump_sum_changes:
                assets += lump_sum_changes[year + 1]

            if assets > 0:
                yearly_assets = np.random.normal(expected_annual_return / 100, expected_annual_volatility / 100) * assets
            else:
                yearly_assets = 0

            yearly_expenses = np.random.normal(initial_yearly_expenses, expenses_volatility)
            yearly_expenses *= (1 + inflation) ** year

            if np.random.rand() < unexpected_expense_chance:
                yearly_expenses += unexpected_expense_amount
                unexpected_expenses_over_years[year] += 1

            income_for_the_year = active_income_over_years[year] + passive_income_over_years[year]
            assets_to_sell = 0
            taxes_paid = 0
            if yearly_expenses > income_for_the_year:
                amount_needed_after_taxes = yearly_expenses - income_for_the_year
                assets_to_sell = amount_needed_after_taxes / (1 - tax_rate)
                taxes_paid = assets_to_sell - amount_needed_after_taxes

            assets += yearly_assets
            assets -= yearly_expenses
            assets -= taxes_paid
            assets += active_income_over_years[year]
            assets += passive_income_over_years[year]

            assets_over_years[sim, year] = assets
            expenses_over_years[sim, year] = yearly_expenses
            net_asset_income_over_years[sim, year] = yearly_assets
            taxes_over_years[sim, year] = taxes_paid

    # Hide progress bar when done
    progress_container = document.getElementById('simulation-progress')
    progress_container.style.display = 'none'
    
    return {
        'assets_over_years': assets_over_years,
        'net_asset_income_over_years': net_asset_income_over_years,
        'expenses_over_years': expenses_over_years,
        'taxes_over_years': taxes_over_years,
        'passive_income_over_years': passive_income_over_years,
        'active_income_over_years': active_income_over_years,
        'depletion_threshold': depletion_threshold
    }


def generate_results_table(data):
    assets_over_years = data['assets_over_years']
    net_asset_income_over_years = data['net_asset_income_over_years']
    expenses_over_years = data['expenses_over_years']
    taxes_over_years = data['taxes_over_years']

    median_assets = np.median(assets_over_years, axis=0)
    income_from_assets = np.median(net_asset_income_over_years, axis=0)
    annual_expenses = np.median(expenses_over_years, axis=0)
    annual_taxes = np.median(taxes_over_years, axis=0)

    df = pd.DataFrame({
        'Year': range(1, len(median_assets) + 1),
        'Assets': [f"${x:,.0f}" for x in median_assets],
        'Income from Assets': [f"${x:,.0f}" for x in income_from_assets],
        'Expenses': [f"${x:,.0f}" for x in annual_expenses],
        'Investment Taxes': [f"${x:,.0f}" for x in annual_taxes]
    })
    return df


def calculate_end_stats(data, passive_income_over_years, active_income_over_years, params):
    assets_over_years = data['assets_over_years']
    depletion_threshold = params['Depletion Threshold']
    NUM_SIMULATIONS, NUM_YEARS = assets_over_years.shape

    end_of_simulation_assets = assets_over_years[:, -1]
    years_of_depletion = np.argmax(assets_over_years <= depletion_threshold, axis=1)
    never_depleted = years_of_depletion == 0
    years_of_depletion[never_depleted] = NUM_YEARS + 1
    median_year_depleted = np.median(years_of_depletion[years_of_depletion != NUM_YEARS + 1])

    simulations_with_depletion = np.any(assets_over_years <= depletion_threshold, axis=1)
    depletion_percentage = np.sum(simulations_with_depletion) / NUM_SIMULATIONS * 100

    count_satisfying_simulations = 0
    first_exceeding_years_list = []

    for i in range(NUM_SIMULATIONS):
        net_asset_income_simulation = data['net_asset_income_over_years'][i, :]
        combined_income_simulation = net_asset_income_simulation + passive_income_over_years
        exceeding_years = np.where(combined_income_simulation > data['expenses_over_years'][i, :])[0]
        if len(exceeding_years) > 0:
            first_exceeding_year = exceeding_years[0]
            total_income_subsequent_years = np.sum(combined_income_simulation[first_exceeding_year:])
            total_expenses_subsequent_years = np.sum(data['expenses_over_years'][i, first_exceeding_year:])
            if total_income_subsequent_years > total_expenses_subsequent_years:
                count_satisfying_simulations += 1
                first_exceeding_years_list.append(first_exceeding_year)
    median_first_exceeding_year = np.median(first_exceeding_years_list)

    stats = {
        "Median investable assets left at the end": f"${np.median(end_of_simulation_assets):,.0f}",
        "Percentage of simulations where assets were ever depleted": f"{depletion_percentage:.2f}%",
        "Median year assets depleted": f"Year {median_year_depleted:.1f}" if median_year_depleted != NUM_YEARS + 1 and not np.isnan(median_year_depleted) else "Never",
        "Percentage of simulations achieving escape velocity": f"{(count_satisfying_simulations * 100 / NUM_SIMULATIONS):.2f}%",
        "Median first year escape": f"{median_first_exceeding_year:.0f}"
    }
    return stats


def plot_results(data, passive_income_over_years, active_income_over_years):
    assets_over_years = data['assets_over_years']
    net_asset_income_over_years = data['net_asset_income_over_years']
    expenses_over_years = data['expenses_over_years']
    NUM_SIMULATIONS, NUM_YEARS = assets_over_years.shape
    initial_investable_assets = float(document.getElementById('assets').value)

    plt.figure(figsize=(10,5))
    for sim in range(NUM_SIMULATIONS):
        plt.plot(range(NUM_YEARS), assets_over_years[sim,:], color='blue', alpha=0.1)
    plt.title('Assets over Years for Each Simulation')
    plt.xlabel('Years')
    plt.ylabel('Assets ($)')
    display(plt.gcf(), target="results")
    plt.close()

    y_axis_limit = np.percentile(assets_over_years, 97.5)
    medians = np.median(assets_over_years, axis=0)
    extended_years = [0] + list(range(1, NUM_YEARS + 1))
    extended_medians = [initial_investable_assets] + list(medians)
    year_0_data = np.full((NUM_SIMULATIONS, 1), initial_investable_assets)
    assets_over_years_with_0 = np.hstack((year_0_data, assets_over_years))

    plt.figure(figsize=(15,7))
    plt.plot(extended_years, extended_medians, color='red', marker='o', label='Median', zorder=2)
    boxprops = dict(linestyle='-', linewidth=1, color='blue')
    medianprops = dict(linestyle='-', linewidth=0)
    plt.boxplot(assets_over_years_with_0, vert=True, patch_artist=True, widths=0.6, boxprops=boxprops, medianprops=medianprops, positions=extended_years)
    plt.title('Box Plot of Investable Assets Over Years')
    plt.xlabel('Year')
    plt.ylabel('Investable Assets')
    plt.grid(True, which='both', linestyle='--', linewidth=0.5)
    plt.xticks(extended_years)
    plt.ylim(-initial_investable_assets, y_axis_limit)
    plt.xlim(0, NUM_YEARS + 1)
    display(plt.gcf(), target="results")
    plt.close()

    years = np.arange(1, NUM_YEARS + 1)
    plt.figure(figsize=(12,8))
    plt.plot(years, np.median(net_asset_income_over_years, axis=0), '-o', label='Median Net Asset Income', color='blue')
    plt.plot(years, np.median(expenses_over_years, axis=0), '-o', label='Median Expenses', color='red')
    plt.plot(years, active_income_over_years, '-o', label='Active Income', color='green')
    plt.plot(years, passive_income_over_years, '-o', label='Passive Income', color='purple')
    plt.title('Income and Expenses Over Years')
    plt.xlabel('Years')
    plt.ylabel('Amount ($)')
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    display(plt.gcf(), target="results")
    plt.close()

    plt.figure(figsize=(12,8))
    plt.plot(years, np.median(net_asset_income_over_years, axis=0), '-o', label='Median Net Asset Income', color='blue')
    plt.plot(years, np.median(expenses_over_years, axis=0), '-o', label='Median Expenses', color='red')
    plt.plot(years, active_income_over_years, '-o', label='Active Income', color='green')
    plt.plot(years, passive_income_over_years, '-o', label='Passive Income', color='purple')
    for year, change in lump_sum_changes.items():
        plt.scatter(year, change, color='black', s=100, zorder=5, marker='x', label=f'Lump Sum Change (Year {year})')
    plt.title('Income and Expenses Over Years with Lump Sum Changes')
    plt.xlabel('Years')
    plt.ylabel('Amount ($)')
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    display(plt.gcf(), target="results")
    plt.close()

    percentage_covered = (net_asset_income_over_years + passive_income_over_years[np.newaxis,:]) / expenses_over_years * 100
    plt.figure(figsize=(15,10))
    plt.boxplot(percentage_covered, patch_artist=True)
    plt.axhline(y=100, color='green', linestyle='-', linewidth=4, label='100% Coverage')
    plt.title('Distribution of Percentage of Expenses Covered')
    plt.xlabel('Years')
    plt.ylabel('Percentage Covered (%)')
    plt.grid(True, which='both', linestyle='--', linewidth=0.5, axis='y')
    display(plt.gcf(), target="results")
    plt.close()


async def export_to_pdf(event=None):
    # Hide the export button during PDF generation
    export_btn = document.getElementById('export_pdf')
    export_btn.style.display = 'none'
    
    # Create PDF
    pdf = window.jspdf.jsPDF()
    
    # Add title
    pdf.setFontSize(20)
    pdf.text("Financial Simulation Report", 20, 20)
    
    # Add timestamp
    pdf.setFontSize(10)
    from datetime import datetime
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    pdf.text(f"Generated on: {timestamp}", 20, 30)
    
    # Add input parameters
    pdf.setFontSize(12)
    pdf.text("Simulation Parameters:", 20, 45)
    
    y_position = 55
    params, _ = parse_inputs()
    for key, value in params.items():
        if isinstance(value, float):
            value = f"{value:,.2f}"
        pdf.setFontSize(10)
        pdf.text(f"{key}: {value}", 25, y_position)
        y_position += 7
    
    # Add lump sums
    y_position += 10
    pdf.setFontSize(12)
    pdf.text("Lump Sums:", 20, y_position)
    y_position += 10
    
    if lump_sum_changes:
        pdf.setFontSize(10)
        for year, amount in sorted(lump_sum_changes.items()):
            pdf.text(f"Year {year}: ${amount:,.2f}", 25, y_position)
            y_position += 7
    else:
        pdf.text("No lump sums defined", 25, y_position)
        y_position += 7
    
    # Add results
    y_position += 10
    pdf.setFontSize(12)
    pdf.text("Simulation Results:", 20, y_position)
    y_position += 10
    
    # Get the results div
    results_div = document.getElementById('results')
    
    # Convert each chart to canvas and add to PDF
    for img in results_div.getElementsByTagName('img'):
        # Create a new page for each chart
        pdf.addPage()
        
        # Convert the image to canvas and wait for it to complete
        canvas = await window.html2canvas(img)
        
        # Add the canvas to the PDF
        img_data = canvas.toDataURL('image/png')
        pdf.addImage(img_data, 'PNG', 20, 20, 170, 100)  # Adjust size as needed
    
    # Add tables
    for table in results_div.getElementsByTagName('table'):
        # Create a new page for each table
        pdf.addPage()
        
        # Convert table to canvas and wait for it to complete
        canvas = await window.html2canvas(table)
        
        # Add the canvas to the PDF
        img_data = canvas.toDataURL('image/png')
        pdf.addImage(img_data, 'PNG', 20, 20, 170, 100)  # Adjust size as needed
    
    # Save the PDF
    pdf.save('financial_simulation_report.pdf')
    
    # Show the export button again
    export_btn.style.display = 'inline-block'

def run_sim(event=None):
    document.getElementById('results').innerHTML = ''
    params, lump_sum_changes = parse_inputs()
    sim_data = run_simulation(params, lump_sum_changes)
    df = generate_results_table(sim_data)
    display(df, target="results")
    stats = calculate_end_stats(sim_data, sim_data['passive_income_over_years'], sim_data['active_income_over_years'], params)
    display(pd.DataFrame(stats.items(), columns=['Insight','Value']), target="results")
    plot_results(sim_data, sim_data['passive_income_over_years'], sim_data['active_income_over_years'])
    
    # Show the export button after simulation is complete
    document.getElementById('export_pdf').style.display = 'inline-block'
</py-script>
</body>
</html>
