<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Financial Simulator - PyScript</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color: #333;
            --muted-text-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            font-weight: 700;
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .section-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 35px 50px 30px 50px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 32px 32px;
            /* row & column gap 32px */
            margin-bottom: 24px;
        }

        .section-card+.section-card {
            margin-top: 40px;
        }

        label>input {
            margin-top: 6px;
        }

        .lump-sum-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 32px;
            align-items: end;
        }

        label {
            display: flex;
            flex-direction: column;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        #results img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .button-container {
            margin: 30px 0;
        }

        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #a0a0a0;
        }

        #add_asset,
        #toggle_assets,
        #toggle_lumps {
            padding: 10px;
            font-size: 18px;
            min-width: 42px;
            align-self: end;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        th,
        td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 700;
            color: var(--muted-text-color);
            font-size: 12px;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        td button {
            background-color: var(--danger-color);
        }

        td button:hover {
            background-color: #a71d2a;
        }

        /* Loading bar styles */
        .loading-container {
            display: inline-block;
            min-width: 200px;
        }

        .loading-bar,
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loading-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            height: 100%;
            width: 100%;
            background-color: var(--primary-color);
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 2px;
        }

        .progress-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease-in-out;
            border-radius: 2px;
        }

        .loading-text,
        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: var(--muted-text-color);
        }

        @keyframes loading {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-content pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .assets-input-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr) auto;
            gap: 32px;
            align-items: end;
            margin-bottom: 24px;
        }

        .info-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background-color: transparent;
            color: var(--primary-color);
        }

        .info-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .header { display:flex; align-items:center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 30px; }
        .header-buttons button { margin-left: 10px; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Financial Simulator</h1>
            <div class="header-buttons">
                <button id="openInstructions" style="font-size: 14px; font-weight: 500;">Interpreting Results</button>
                <button id="openFEV" style="font-size: 14px; font-weight: 500;">What is FEV?</button>
            </div>
        </div>

        <div class="section-card">
            <h3>Quick Start</h3>
            <p>It would be trivial to make the best financial decisions if you had a crystal ball that could tell you the
                rate of return every asset would get every year,
                every time an unexpected expense would pop up, etc. While we don't have a crystal ball, we can do much
                better than just random guessing because we do have historical statistics about how certain assset
                classes have performed in the past.
                For instance, the SP500 has historically returned about 10.5% per year with a standard deviation of
                18.5%. This means each year there is a 68% chance that the return will be between -8.0% and 29.0%.
                This program runs many simulations of your financial future, and then does statistics on the results.
            </p>
        </div>
        <div class="section-card">
            <p>
                Most people would vary the input parameters and run multiple simulations. This could help you answer
                questions like:
            <ul></ul>
            <li>How many years will you need to work?</li>
            <li>How sensitive is your situation to unexpected expenses?</li>
            <li>How will refinancing your mortgage today affect your future 10 years from now?</li>
            <li>How much you will be able to afford to contribute to children's college expenses in 12 years?</li>
            <li>How will the composition of your portfolio change over time as different assets have different returns?</li>
            <li>How will your situation change with 3% vs 5% inflation?</li>
            </ul>
            </p>
            <p>Click on the info button next to each section to see important details and caveats</p>
        </div>

        <div class="section-card">
            <h3>General Parameters <button class="info-btn" data-info="general">ℹ️</button></h3>
            <div class="input-grid">
                <label>Random Seed <input id="seed" type="number" value="42"></label>
                <label>Years <input id="years" type="number" value="20"></label>
                <label>Simulations <input id="sims" type="number" value="100"></label>
                <label>Tax Rate (%) <input id="tax_rate" type="number" value="0.2" step="0.01"></label>
                <label>Inflation (%) <input id="inflation" type="number" value="0.03" step="0.01"></label>
                <label>Depletion Threshold ($) <input id="depletion" class="format-number" type="text"
                        value="20000"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Assets / Liabilities<button class="info-btn" data-info="assets">ℹ️</button><button id="toggle_assets"
                    style="margin-left:auto;">+</button></h3>
            <div id="assets_section" style="display:none;">
                <!-- Input row for creating a new asset -->
                <div class="assets-input-row">
                    <label>Name <input id="asset_name" type="text" placeholder="e.g. Index Fund"></label>
                    <label>Value ($) <input id="asset_value" class="format-number" type="text"
                            placeholder="100,000"></label>
                    <label>Expected Return Mean (%) <input id="asset_ret_mean" type="number" step="0.01"
                            placeholder="7"></label>
                    <label>Expected Return SD (%) <input id="asset_ret_sd" type="number" step="0.01"
                            placeholder="15"></label>
                    <button id="add_asset" class="icon-btn" py-click="add_asset">+</button>
                </div>

                <!-- Table displaying current assets -->
                <div id="assets_table_container" style="margin-top: 10px;">
                    <table id="assets_table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Value ($)</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Mean %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">SD %</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="assets_body"></tbody>
                    </table>
                </div>

                <!-- Error message for asset input -->
                <div id="asset_error" style="color: red; margin-top: 5px;"></div>
            </div> <!-- End assets_section -->
        </div>

        <div class="section-card">
            <h3>Active Income <button class="info-btn" data-info="active">ℹ️</button></h3>
            <div class="input-grid">
                <label>Active Income ($) <input id="active_income" class="format-number" type="text"
                        value="65000"></label>
                <label>Active Income Growth Rate (%) <input id="active_growth" type="number" value="0.02"
                        step="0.01"></label>
                <label>Years to Work <input id="years_work" type="number" value="15"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Passive Income <button class="info-btn" data-info="passive">ℹ️</button></h3>
            <div class="input-grid">
                <label>Additional Passive Income ($) <input id="passive_income" class="format-number" type="text"
                        value="5000"></label>
                <label>Passive Income Growth Rate (%) <input id="passive_growth" type="number" value="0.02"
                        step="0.01"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Expenses <button class="info-btn" data-info="expenses">ℹ️</button></h3>
            <div class="input-grid">
                <label>Expected Expenses Mean ($) <input id="exp_mean" class="format-number" type="text"
                        value="50000"></label>
                <label>Expected Expenses SD ($) <input id="exp_sd" class="format-number" type="text"
                        value="10000"></label>
                <label>Unexpected Expense Chance (%) <input id="unexpected_chance" type="number" value="0.15"
                        step="0.01"></label>
                <label>Unexpected Expense Amount ($) <input id="unexpected_amount" class="format-number" type="text"
                        value="10000"></label>
            </div>
        </div>

        <div class="section-card">
            <h3>Lump Sums <button class="info-btn" data-info="lumps">ℹ️</button><button id="toggle_lumps"
                    style="margin-left:auto;">+</button></h3>
            <div id="lump_section" style="display:none;">
                <div class="lump-sum-input-row">
                    <label>Year <input id="lump_year" type="number" min="1" value="1"></label>
                    <label>Amount ($) <input id="lump_amount" class="format-number" type="text" value="0"></label>
                    <button id="add_lump_sum" class="icon-btn" py-click="add_lump_sum">+</button>
                </div>
                <div id="lump_sums_table_container" style="margin-top: 20px;">
                    <table id="lump_sums_table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="lump_sums_body">
                        </tbody>
                    </table>
                </div>
            </div> <!-- end lump_section -->
        </div>

        <div class="button-container">
            <div id="initial-loading" class="loading-container">
                <div class="loading-bar"></div>
                <div class="loading-text">Loading Python dependencies...</div>
            </div>
            <button id="run" py-click="run_sim" disabled style="opacity: 0.6; cursor: not-allowed;">Run
                Simulation</button>
            <button id="export_pdf" py-click="export_to_pdf" style="display: none;">Export to PDF</button>
        </div>

        <div id="results"></div>

        <py-config>
            packages = ["numpy", "pandas", "matplotlib"]
        </py-config>

        <py-script>
            import numpy as np
            import pandas as pd
            import matplotlib.pyplot as plt
            import asyncio
            from js import document, window
            from pyscript import display
            from pyodide.ffi import create_proxy
            
            def check_page_ready():
                # Check if the Add Lump Sum button is available and not disabled
                add_button = document.getElementById('add_lump_sum')
                if add_button and not add_button.disabled:
                    # Page is fully ready, stop the spinner and show run button
                    initial_loading = document.getElementById('initial-loading')
                    run_button = document.getElementById('run')
                    if initial_loading and run_button:
                        # Remove the loading animation
                        loading_bar = initial_loading.querySelector('.loading-bar')
                        if loading_bar:
                            loading_bar.style.animation = 'none'
                        initial_loading.style.display = 'none'
                        run_button.disabled = False
                        run_button.style.opacity = '1'
                        run_button.style.cursor = 'pointer'
                else:
                    # Check again in a short while
                    window.setTimeout(create_proxy(check_page_ready), 100)
            
            # Start checking for page readiness
            check_page_ready()
            
            # Store lump sums in a global variable
            lump_sum_changes = {}
            
            # Store assets as list of dicts: {'name': str, 'value': float, 'mean': float, 'sd': float}
            asset_list = []
            
            def update_assets_table():
                tbody = document.getElementById('assets_body')
                tbody.innerHTML = ''
            
                for idx, asset in enumerate(asset_list):
                    row = document.createElement('tr')
            
                    def make_cell(text):
                        cell = document.createElement('td')
                        cell.textContent = text
                        return cell
            
                    row.appendChild(make_cell(asset['name']))
                    row.appendChild(make_cell(f"${asset['value']:,.0f}"))
                    row.appendChild(make_cell(f"{asset['mean']:.2f}%"))
                    row.appendChild(make_cell(f"{asset['sd']:.2f}%"))
            
                    # Remove button
                    action_cell = document.createElement('td')
                    remove_btn = document.createElement('button')
                    remove_btn.textContent = '-'
                    remove_btn.setAttribute('data-idx', str(idx))
                    remove_btn.onclick = lambda e: remove_asset(int(e.target.getAttribute('data-idx')))
                    action_cell.appendChild(remove_btn)
                    row.appendChild(action_cell)
            
                    tbody.appendChild(row)
            
            def add_asset(event=None):
                name = document.getElementById('asset_name').value.strip()
                def to_float(val):
                    try:
                        return float(val)
                    except ValueError:
                        return 0.0
            
                value = to_float(document.getElementById('asset_value').value)
                mean = to_float(document.getElementById('asset_ret_mean').value)
                sd = to_float(document.getElementById('asset_ret_sd').value)
            
                error_el = document.getElementById('asset_error')
                error_message = ''
                if not name:
                    error_message = 'Name is required.'
                elif value <= 0:
                    error_message = 'Value must be positive.'
                elif mean == 0:
                    error_message = 'Expected return mean cannot be 0 (positive or negative allowed).'
                elif sd <= 0:
                    error_message = 'Expected return SD must be positive.'
            
                if error_message:
                    error_el.innerHTML = error_message
                    return
                else:
                    error_el.innerHTML = ''
            
                asset_list.append({'name': name, 'value': value, 'mean': mean, 'sd': sd})
                update_assets_table()
            
                # Clear inputs
                document.getElementById('asset_name').value = ''
                document.getElementById('asset_value').value = ''
                document.getElementById('asset_ret_mean').value = ''
                document.getElementById('asset_ret_sd').value = ''
            
            def remove_asset(idx, event=None):
                try:
                    idx_int = int(idx)
                except ValueError:
                    return
                if 0 <= idx_int < len(asset_list):
                    asset_list.pop(idx_int)
                    update_assets_table()
            
            def add_lump_sum(event=None):
                year = int(document.getElementById('lump_year').value)
                amount = float(document.getElementById('lump_amount').value)
                max_years = int(document.getElementById('years').value)
                
                if year < 1 or year > max_years:
                    return
                
                lump_sum_changes[year] = amount
                update_lump_sums_table()
                
                # Clear the input fields
                document.getElementById('lump_year').value = "1"
                document.getElementById('lump_amount').value = "0"
            
            def remove_lump_sum(year, event=None):
                # Convert year to int to ensure we're using a hashable type
                year_int = int(year)
                if year_int in lump_sum_changes:
                    del lump_sum_changes[year_int]
                    update_lump_sums_table()
            
            def update_lump_sums_table():
                tbody = document.getElementById('lump_sums_body')
                tbody.innerHTML = ''
                
                for year in sorted(lump_sum_changes.keys()):
                    amount = lump_sum_changes[year]
                    row = document.createElement('tr')
                    
                    # Year cell
                    year_cell = document.createElement('td')
                    year_cell.textContent = str(year)
                    row.appendChild(year_cell)
                    
                    # Amount cell
                    amount_cell = document.createElement('td')
                    amount_cell.textContent = f"${amount:,.2f}"
                    row.appendChild(amount_cell)
                    
                    # Remove button cell
                    button_cell = document.createElement('td')
                    remove_button = document.createElement('button')
                    remove_button.textContent = 'Remove'
                    # Store the year as a data attribute and use a regular function
                    remove_button.setAttribute('data-year', str(year))
                    remove_button.onclick = lambda e: remove_lump_sum(e.target.getAttribute('data-year'))
                    button_cell.appendChild(remove_button)
                    row.appendChild(button_cell)
                    
                    tbody.appendChild(row)
            
            def parse_inputs():
                get_val = lambda i: document.getElementById(i).value
                # ----- Compute portfolio stats from asset_list -----
                if asset_list:
                    total_val = sum(a['value'] for a in asset_list)
                    weights = [a['value']/total_val for a in asset_list]
                    weighted_mean = sum(w * a['mean'] for w, a in zip(weights, asset_list))
                    weighted_var = sum((w**2) * (a['sd']**2) for w, a in zip(weights, asset_list))
                else:
                    total_val = 0
                    weighted_mean = 0
                    weighted_var = 0
            
                data = {
                    'Random Seed': int(get_val('seed')),
                    'Years': int(get_val('years')),
                    'Simulations': int(get_val('sims')),
                    'Tax Rate': float(get_val('tax_rate')),
                    'Inflation': float(get_val('inflation')),
                    'Depletion Threshold': float(get_val('depletion')),
                    'Investable Assets': total_val,
                    'Expected Return Mean': weighted_mean,
                    'Expected Return SD': weighted_var ** 0.5,
                    'Expected Expenses Mean': float(get_val('exp_mean')),
                    'Expected Expenses SD': float(get_val('exp_sd')),
                    'Unexpected Expense Chance': float(get_val('unexpected_chance')),
                    'Unexpected Expense Amount': float(get_val('unexpected_amount')),
                    'Additional Passive Income': float(get_val('passive_income')),
                    'Passive Income Growth Rate': float(get_val('passive_growth')),
                    'Active Income': float(get_val('active_income')),
                    'Active Income Growth Rate': float(get_val('active_growth')),
                    'Years to Work': int(get_val('years_work'))
                }
                return data, lump_sum_changes
            
            # Simulation functions adapted from simulation.py
            
            def run_simulation(params, lump_sum_changes):
                np.random.seed(int(params['Random Seed']))
                NUM_SIMULATIONS = int(params['Simulations'])
                NUM_YEARS = int(params['Years'])
                initial_investable_assets = params['Investable Assets']
                expected_annual_return = params['Expected Return Mean']
                expected_annual_volatility = params['Expected Return SD']
                initial_yearly_expenses = params['Expected Expenses Mean']
                expenses_volatility = params['Expected Expenses SD']
                inflation = params['Inflation']
                unexpected_expense_chance = params['Unexpected Expense Chance']
                unexpected_expense_amount = params['Unexpected Expense Amount']
                passive_income = params['Additional Passive Income']
                years_to_work = params['Years to Work']
                active_income = params['Active Income']
                tax_rate = params['Tax Rate']
                active_income_growth_rate = params['Active Income Growth Rate']
                passive_income_growth_rate = params['Passive Income Growth Rate']
                depletion_threshold = params['Depletion Threshold']
            
                assets_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
                net_asset_income_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
                expenses_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
                taxes_over_years = np.zeros((NUM_SIMULATIONS, NUM_YEARS))
                unexpected_expenses_over_years = np.zeros(NUM_YEARS)
            
                active_income_over_years = []
                for year in range(NUM_YEARS):
                    if year < years_to_work:
                        income_for_year = active_income * (1 + active_income_growth_rate) ** year
                        active_income_over_years.append(income_for_year)
                    else:
                        active_income_over_years.append(0)
                active_income_over_years = np.array(active_income_over_years)
            
                passive_income_over_years = []
                for year in range(NUM_YEARS):
                    passive_income_for_year = passive_income * (1 + passive_income_growth_rate) ** year
                    passive_income_over_years.append(passive_income_for_year)
                passive_income_over_years = np.array(passive_income_over_years)
            
                for sim in range(NUM_SIMULATIONS):
                    assets = initial_investable_assets
                    for year in range(NUM_YEARS):
                        if year + 1 in lump_sum_changes:
                            assets += lump_sum_changes[year + 1]
            
                        if assets > 0:
                            yearly_assets = np.random.normal(expected_annual_return / 100, expected_annual_volatility / 100) * assets
                        else:
                            yearly_assets = 0
            
                        yearly_expenses = np.random.normal(initial_yearly_expenses, expenses_volatility)
                        yearly_expenses *= (1 + inflation) ** year
            
                        if np.random.rand() < unexpected_expense_chance:
                            yearly_expenses += unexpected_expense_amount
                            unexpected_expenses_over_years[year] += 1
            
                        income_for_the_year = active_income_over_years[year] + passive_income_over_years[year]
                        assets_to_sell = 0
                        taxes_paid = 0
                        if yearly_expenses > income_for_the_year:
                            amount_needed_after_taxes = yearly_expenses - income_for_the_year
                            assets_to_sell = amount_needed_after_taxes / (1 - tax_rate)
                            taxes_paid = assets_to_sell - amount_needed_after_taxes
            
                        assets += yearly_assets
                        assets -= yearly_expenses
                        assets -= taxes_paid
                        assets += active_income_over_years[year]
                        assets += passive_income_over_years[year]
            
                        assets_over_years[sim, year] = assets
                        expenses_over_years[sim, year] = yearly_expenses
                        net_asset_income_over_years[sim, year] = yearly_assets
                        taxes_over_years[sim, year] = taxes_paid
            
                return {
                    'assets_over_years': assets_over_years,
                    'net_asset_income_over_years': net_asset_income_over_years,
                    'expenses_over_years': expenses_over_years,
                    'taxes_over_years': taxes_over_years,
                    'passive_income_over_years': passive_income_over_years,
                    'active_income_over_years': active_income_over_years,
                    'depletion_threshold': depletion_threshold
                }
            
            
            def generate_results_table(data):
                assets_over_years = data['assets_over_years']
                net_asset_income_over_years = data['net_asset_income_over_years']
                expenses_over_years = data['expenses_over_years']
                taxes_over_years = data['taxes_over_years']
            
                median_assets = np.median(assets_over_years, axis=0)
                income_from_assets = np.median(net_asset_income_over_years, axis=0)
                annual_expenses = np.median(expenses_over_years, axis=0)
                annual_taxes = np.median(taxes_over_years, axis=0)
            
                df = pd.DataFrame({
                    'Year': range(1, len(median_assets) + 1),
                    'Assets': [f"${x:,.0f}" for x in median_assets],
                    'Income from Assets': [f"${x:,.0f}" for x in income_from_assets],
                    'Expenses': [f"${x:,.0f}" for x in annual_expenses],
                    'Investment Taxes': [f"${x:,.0f}" for x in annual_taxes]
                })
                return df
            
            
            def calculate_end_stats(data, passive_income_over_years, active_income_over_years, params):
                assets_over_years = data['assets_over_years']
                depletion_threshold = params['Depletion Threshold']
                NUM_SIMULATIONS, NUM_YEARS = assets_over_years.shape
            
                end_of_simulation_assets = assets_over_years[:, -1]
                years_of_depletion = np.argmax(assets_over_years <= depletion_threshold, axis=1)
                never_depleted = years_of_depletion == 0
                years_of_depletion[never_depleted] = NUM_YEARS + 1
                median_year_depleted = np.median(years_of_depletion[years_of_depletion != NUM_YEARS + 1])
            
                simulations_with_depletion = np.any(assets_over_years <= depletion_threshold, axis=1)
                depletion_percentage = np.sum(simulations_with_depletion) / NUM_SIMULATIONS * 100
            
                count_satisfying_simulations = 0
                first_exceeding_years_list = []
            
                for i in range(NUM_SIMULATIONS):
                    net_asset_income_simulation = data['net_asset_income_over_years'][i, :]
                    combined_income_simulation = net_asset_income_simulation + passive_income_over_years
                    exceeding_years = np.where(combined_income_simulation > data['expenses_over_years'][i, :])[0]
                    if len(exceeding_years) > 0:
                        first_exceeding_year = exceeding_years[0]
                        total_income_subsequent_years = np.sum(combined_income_simulation[first_exceeding_year:])
                        total_expenses_subsequent_years = np.sum(data['expenses_over_years'][i, first_exceeding_year:])
                        if total_income_subsequent_years > total_expenses_subsequent_years:
                            count_satisfying_simulations += 1
                            first_exceeding_years_list.append(first_exceeding_year)
                median_first_exceeding_year = np.median(first_exceeding_years_list)
            
                stats = {
                    "Median investable assets left at the end": f"${np.median(end_of_simulation_assets):,.0f}",
                    "Percentage of simulations where assets were ever depleted": f"{depletion_percentage:.2f}%",
                    "Median year assets depleted": f"Year {median_year_depleted:.1f}" if median_year_depleted != NUM_YEARS + 1 and not np.isnan(median_year_depleted) else "Never",
                    "Percentage of simulations achieving escape velocity": f"{(count_satisfying_simulations * 100 / NUM_SIMULATIONS):.2f}%",
                    "Median first year escape": f"{median_first_exceeding_year:.0f}"
                }
                return stats
            
            
            def plot_results(data, passive_income_over_years, active_income_over_years):
                assets_over_years = data['assets_over_years']
                net_asset_income_over_years = data['net_asset_income_over_years']
                expenses_over_years = data['expenses_over_years']
                NUM_SIMULATIONS, NUM_YEARS = assets_over_years.shape
                initial_investable_assets = float(document.getElementById('assets').value)
            
                plt.figure(figsize=(10,5))
                for sim in range(NUM_SIMULATIONS):
                    plt.plot(range(NUM_YEARS), assets_over_years[sim,:], color='blue', alpha=0.1)
                plt.title('Assets over Years for Each Simulation')
                plt.xlabel('Years')
                plt.ylabel('Assets ($)')
                display(plt.gcf(), target="results")
                plt.close()
            
                y_axis_limit = np.percentile(assets_over_years, 97.5)
                medians = np.median(assets_over_years, axis=0)
                extended_years = [0] + list(range(1, NUM_YEARS + 1))
                extended_medians = [initial_investable_assets] + list(medians)
                year_0_data = np.full((NUM_SIMULATIONS, 1), initial_investable_assets)
                assets_over_years_with_0 = np.hstack((year_0_data, assets_over_years))
            
                plt.figure(figsize=(15,7))
                plt.plot(extended_years, extended_medians, color='red', marker='o', label='Median', zorder=2)
                boxprops = dict(linestyle='-', linewidth=1, color='blue')
                medianprops = dict(linestyle='-', linewidth=0)
                plt.boxplot(assets_over_years_with_0, vert=True, patch_artist=True, widths=0.6, boxprops=boxprops, medianprops=medianprops, positions=extended_years)
                plt.title('Box Plot of Investable Assets Over Years')
                plt.xlabel('Year')
                plt.ylabel('Investable Assets')
                plt.grid(True, which='both', linestyle='--', linewidth=0.5)
                plt.xticks(extended_years)
                plt.ylim(-initial_investable_assets, y_axis_limit)
                plt.xlim(0, NUM_YEARS + 1)
                display(plt.gcf(), target="results")
                plt.close()
            
                years = np.arange(1, NUM_YEARS + 1)
                plt.figure(figsize=(12,8))
                plt.plot(years, np.median(net_asset_income_over_years, axis=0), '-o', label='Median Net Asset Income', color='blue')
                plt.plot(years, np.median(expenses_over_years, axis=0), '-o', label='Median Expenses', color='red')
                plt.plot(years, active_income_over_years, '-o', label='Active Income', color='green')
                plt.plot(years, passive_income_over_years, '-o', label='Passive Income', color='purple')
                plt.title('Income and Expenses Over Years')
                plt.xlabel('Years')
                plt.ylabel('Amount ($)')
                plt.legend()
                plt.grid(True)
                plt.tight_layout()
                display(plt.gcf(), target="results")
                plt.close()
            
                plt.figure(figsize=(12,8))
                plt.plot(years, np.median(net_asset_income_over_years, axis=0), '-o', label='Median Net Asset Income', color='blue')
                plt.plot(years, np.median(expenses_over_years, axis=0), '-o', label='Median Expenses', color='red')
                plt.plot(years, active_income_over_years, '-o', label='Active Income', color='green')
                plt.plot(years, passive_income_over_years, '-o', label='Passive Income', color='purple')
                for year, change in lump_sum_changes.items():
                    plt.scatter(year, change, color='black', s=100, zorder=5, marker='x', label=f'Lump Sum Change (Year {year})')
                plt.title('Income and Expenses Over Years with Lump Sum Changes')
                plt.xlabel('Years')
                plt.ylabel('Amount ($)')
                plt.legend()
                plt.grid(True)
                plt.tight_layout()
                display(plt.gcf(), target="results")
                plt.close()
            
                percentage_covered = (net_asset_income_over_years + passive_income_over_years[np.newaxis,:]) / expenses_over_years * 100
                plt.figure(figsize=(15,10))
                plt.boxplot(percentage_covered, patch_artist=True)
                plt.axhline(y=100, color='green', linestyle='-', linewidth=4, label='100% Coverage')
                plt.title('Distribution of Percentage of Expenses Covered')
                plt.xlabel('Years')
                plt.ylabel('Percentage Covered (%)')
                plt.grid(True, which='both', linestyle='--', linewidth=0.5, axis='y')
                display(plt.gcf(), target="results")
                plt.close()
            
            
            async def export_to_pdf(event=None):
                # Hide the export button during PDF generation
                export_btn = document.getElementById('export_pdf')
                export_btn.style.display = 'none'
                
                # Create PDF
                pdf = window.jspdf.jsPDF()
                
                # Add title
                pdf.setFontSize(20)
                pdf.text("Financial Simulation Report", 20, 20)
                
                # Add timestamp
                pdf.setFontSize(10)
                from datetime import datetime
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                pdf.text(f"Generated on: {timestamp}", 20, 30)
                
                # Add input parameters
                pdf.setFontSize(12)
                pdf.text("Simulation Parameters:", 20, 45)
                
                y_position = 55
                params, _ = parse_inputs()
                for key, value in params.items():
                    if isinstance(value, float):
                        value = f"{value:,.2f}"
                    pdf.setFontSize(10)
                    pdf.text(f"{key}: {value}", 25, y_position)
                    y_position += 7
                
                # Add lump sums
                y_position += 10
                pdf.setFontSize(12)
                pdf.text("Lump Sums:", 20, y_position)
                y_position += 10
                
                if lump_sum_changes:
                    pdf.setFontSize(10)
                    for year, amount in sorted(lump_sum_changes.items()):
                        pdf.text(f"Year {year}: ${amount:,.2f}", 25, y_position)
                        y_position += 7
                else:
                    pdf.text("No lump sums defined", 25, y_position)
                    y_position += 7
                
                # Add results
                y_position += 10
                pdf.setFontSize(12)
                pdf.text("Simulation Results:", 20, y_position)
                y_position += 10
                
                # Get the results div
                results_div = document.getElementById('results')
                
                # Convert each chart to canvas and add to PDF
                for img in results_div.getElementsByTagName('img'):
                    # Create a new page for each chart
                    pdf.addPage()
                    
                    # Convert the image to canvas and wait for it to complete
                    canvas = await window.html2canvas(img)
                    
                    # Add the canvas to the PDF
                    img_data = canvas.toDataURL('image/png')
                    pdf.addImage(img_data, 'PNG', 20, 20, 170, 100)  # Adjust size as needed
                
                # Add tables
                for table in results_div.getElementsByTagName('table'):
                    # Create a new page for each table
                    pdf.addPage()
                    
                    # Convert table to canvas and wait for it to complete
                    canvas = await window.html2canvas(table)
                    
                    # Add the canvas to the PDF
                    img_data = canvas.toDataURL('image/png')
                    pdf.addImage(img_data, 'PNG', 20, 20, 170, 100)  # Adjust size as needed
                
                # Save the PDF
                pdf.save('financial_simulation_report.pdf')
                
                # Show the export button again
                export_btn.style.display = 'inline-block'
            
            async def run_sim(event=None):
                # Update button text to indicate simulation is running
                run_button = document.getElementById('run')
                if run_button:
                    run_button.textContent = 'Simulating...'
            
                # Yield to the browser so it can repaint the updated button text
                await asyncio.sleep(0)
            
                document.getElementById('results').innerHTML = ''
                params, lump_sum_changes = parse_inputs()
                sim_data = run_simulation(params, lump_sum_changes)
                df = generate_results_table(sim_data)
                display(df, target="results")
                stats = calculate_end_stats(sim_data, sim_data['passive_income_over_years'], sim_data['active_income_over_years'], params)
                display(pd.DataFrame(stats.items(), columns=['Insight','Value']), target="results")
                plot_results(sim_data, sim_data['passive_income_over_years'], sim_data['active_income_over_years'])
                
                # Show the export button after simulation is complete
                document.getElementById('export_pdf').style.display = 'inline-block'
             
            </py-script>

        <script>
            // Change button text to 'Simulating...' when clicked, and restore after simulation
            document.addEventListener('DOMContentLoaded', function () {
                var runBtn = document.getElementById('run');
                if (runBtn) {
                    runBtn.addEventListener('click', function () {
                        runBtn.textContent = 'Simulating...';
                    });
                }
                // Use a MutationObserver to watch for the export button to appear, which signals simulation is done
                var exportBtn = document.getElementById('export_pdf');
                if (exportBtn) {
                    var observer = new MutationObserver(function (mutations) {
                        mutations.forEach(function (mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                if (exportBtn.style.display !== 'none') {
                                    if (runBtn) runBtn.textContent = 'Run Simulation';
                                }
                            }
                        });
                    });
                    observer.observe(exportBtn, { attributes: true });
                }

                // Toggle Assets section visibility
                var toggleAssetsBtn = document.getElementById('toggle_assets');
                var assetsSection = document.getElementById('assets_section');
                if (toggleAssetsBtn && assetsSection) {
                    toggleAssetsBtn.addEventListener('click', function () {
                        if (assetsSection.style.display === 'none') {
                            assetsSection.style.display = 'block';
                            toggleAssetsBtn.textContent = '-';
                        } else {
                            assetsSection.style.display = 'none';
                            toggleAssetsBtn.textContent = '+';
                        }
                    });
                }

                // Toggle Lump Sums section visibility
                var toggleLumpsBtn = document.getElementById('toggle_lumps');
                var lumpSection = document.getElementById('lump_section');
                if (toggleLumpsBtn && lumpSection) {
                    toggleLumpsBtn.addEventListener('click', function () {
                        if (lumpSection.style.display === 'none') {
                            lumpSection.style.display = 'block';
                            toggleLumpsBtn.textContent = '-';
                        } else {
                            lumpSection.style.display = 'none';
                            toggleLumpsBtn.textContent = '+';
                        }
                    });
                }

                // Instructions modal logic
                var modal = document.getElementById('instructionsModal');
                var openBtn = document.getElementById('openInstructions');
                var closeBtn = document.getElementById('closeInstructions');
                if (openBtn && modal && closeBtn) {
                    openBtn.addEventListener('click', function () { modal.style.display = 'block'; });
                    closeBtn.addEventListener('click', function () { modal.style.display = 'none'; });
                    window.addEventListener('click', function (event) { if (event.target === modal) { modal.style.display = 'none'; } });
                }

                // Add comma formatting for inputs with class format-number
                function addFormatListeners(input) {
                    input.addEventListener('focus', function () {
                        input.value = input.value.replace(/,/g, '');
                    });
                    input.addEventListener('blur', function () {
                        if (input.value !== '') {
                            const num = Number(input.value.replace(/,/g, ''));
                            if (!isNaN(num)) {
                                input.value = num.toLocaleString('en-US');
                            }
                        }
                    });
                }
                document.querySelectorAll('input.format-number').forEach(addFormatListeners);

                // Card info modal logic
                var cardModal = document.getElementById('cardInfoModal');
                var cardBody = document.getElementById('cardInfoBody');
                var closeCard = document.getElementById('closeCardInfo');

                const infoContent = {
                    general: `<h2>General Parameters</h2><p>These parameters control the overall simulation length and randomness.</p><ul><li><b>Random Seed</b>: ensures repeatable runs.</li><li><b>Years</b>: duration of the simulation.</li><li><b>Simulations</b>: number of Monte Carlo trials to run.</li><li><b>Tax Rate</b>: percentage applied to capital gains when assets are sold.</li><li><b>Inflation</b>: annual increase applied to expenses.</li><li><b>Depletion Threshold</b>: asset level considered &quot;out of money&quot;.</li></ul>`,
                    assets: `<h2>Assets</h2><p>Add each investable asset you own.</p><ul><li><b>Name</b>: descriptive label.</li><li><b>Value ($)</b>: current market value.</li><li><b>Expected Return Mean (%)</b>: average annual return.</li><li><b>Expected Return SD (%)</b>: annual volatility.</li></ul><p>The simulator automatically computes a weighted portfolio return and volatility.</p>`,
                    active: `<h2>Active Income</h2><p>Your employment or business income.</p><ul><li><b>Active Income ($)</b>: after-tax annual pay.</li><li><b>Active Income Growth Rate (%)</b>: expected yearly raises.</li><li><b>Years to Work</b>: number of years this income is earned.</li></ul>`,
                    passive: `<h2>Passive Income</h2><p>Recurring income streams such as pensions, Social Security, or rental income.</p><ul><li><b>Additional Passive Income ($)</b>: current annual amount.</li><li><b>Passive Income Growth Rate (%)</b>: expected yearly change (can be negative).</li></ul>`,
                    expenses: `<h2>Expenses</h2><p>Annual living costs and their variability.</p><ul><li><b>Expected Expenses Mean ($)</b>: typical yearly spending.</li><li><b>Expected Expenses SD ($)</b>: variability of that spending.</li><li><b>Unexpected Expense Chance (%)</b>: probability of a surprise expense each year.</li><li><b>Unexpected Expense Amount ($)</b>: size of that surprise cost.</li></ul>`,
                    lumps: `<h2>Lump Sums</h2><p>Add one-off future cash flows.</p><ul><li><b>Year</b>: simulation year (1-n).</li><li><b>Amount ($)</b>: positive for income, negative for expenses.</li></ul>`
                };

                document.querySelectorAll('.info-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const key = btn.getAttribute('data-info');
                        cardBody.innerHTML = infoContent[key] || '';
                        cardModal.style.display = 'block';
                    });
                });
                if (closeCard) closeCard.addEventListener('click', () => cardModal.style.display = 'none');
                window.addEventListener('click', e => { if (e.target === cardModal) cardModal.style.display = 'none'; });

                // FEV modal logic
                var fevModal = document.getElementById('fevModal');
                var openFEV = document.getElementById('openFEV');
                var closeFEV = document.getElementById('closeFEV');
                if (openFEV && fevModal && closeFEV) {
                    openFEV.addEventListener('click', () => fevModal.style.display = 'block');
                    closeFEV.addEventListener('click', () => fevModal.style.display = 'none');
                    window.addEventListener('click', e => { if (e.target === fevModal) fevModal.style.display = 'none'; });
                }
            });
        </script>

        <!-- Instructions Modal -->
        <div id="instructionsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeInstructions">&times;</span>
                <h2>Financial Simulator - Intrepreting Results</h2>
                <p><em>"It's hard to make predictions – especially about the future." – Yogi Berra</em></p>

                <h3>How It Works</h3>
                <p>The simulator performs many Monte Carlo trials (&ldquo;Simulations&rdquo;) using the parameters you
                    provide. Each trial randomly samples investment returns, inflation, and expenses to create a
                    possible future trajectory for your finances. Results are aggregated to show medians, distributions,
                    and probabilities.</p>

                <p><b>Medians</b> show the value where half of the simulations came in above and half are below. 
                this is similar to the <b>average</b>, but averages can be more skewed by extreme high or low values (outliers). </p>

                <p><b>Probabilities</b> give the chance of a certain outcome happening. For instance, you might be considering whether to take on a certain monthly
                expenses. The simulator could tell you if it increased your chance of running out of money from 5% to 12%. Similarly, perhaps working 1 more year
            increases your chance of achieving FEV from 10% to 30%. </p>

            <p><b>Distributions</b> show how the probabilities are spread through most outcomes. Normal distributions are assumed for most of this modeling. 
                For instance, the box plot shows the median, the 25th and 75th percentiles, and the 10th and 90th percentiles. 
             </p>
               
                <h3>Interpreting Results</h3>
                <p>After running, you&rsquo;ll receive:</p>
                <ul>
                    <li><b>Median Trajectories &amp; Box Plots</b> for investable assets.</li>
                    <li><b>Income vs. Expenses</b> charts.</li>
                    <li><b>Key Insights</b> table – chance of depletion, chance of achieving FEV, etc.</li>
                </ul>

                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/key_insights.jpg"
                    alt="Key Insights" style="max-width: 100%; margin: 10px 0;" />
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/table1.jpg"
                    alt="Summary Table" style="max-width: 100%; margin: 10px 0;" />
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/assets_over_years.jpg"
                    alt="Assets Over Years" style="max-width: 100%; margin: 10px 0;" />

            </div>
        </div>

        <!-- Card Info Modal -->
        <div id="cardInfoModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeCardInfo">&times;</span>
                <div id="cardInfoBody"></div>
            </div>
        </div>

        <!-- FEV Modal -->
        <div id="fevModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeFEV">&times;</span>
                <h2>Financial Escape Velocity (FEV)</h2>
                <p>This is a graph of net worth over time for a typical person. Generally, their net worth will increase
                    until they retire, but then it will decrease as they start to spend down their assets. The question of
                    retirement becomes "will I run out of money before I die?"</p>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/net_worth_over_time.png"
                    alt="Net Worth Over Time" style="max-width: 100%; margin: 10px 0;" />
                <p></p> Another, related but more difficult goal to achieve is what I call <b>'Financial Escape
                    Velocity'</b>, or being able to increase your net worth through passive and investment income. This
                is similar to how a rocket needs to reach a certain speed to escape Earth's gravity - once achieved, the
                momentum becomes self-sustaining. Those who achieve FEV will generally have their net worth
                <em>increase</em>
                with age. </p>
                <p>Imagine - if your income is $1,000 / month in retirement - if you spend $1,001 per month, eventually
                    you will run out of money. However, if you spend $999 per month, you will increase your assets each
                    month.</p>

                <p>The simulator looks across every single Monte-Carlo trial and flags the first year where:</p>
                <ul>
                    <li>Passive&nbsp;Income&nbsp;+ Median&nbsp;Asset&nbsp;Return ≥ Expenses</li>
                    <li>and the <em>cumulative</em> income after that point continues to outpace cumulative expenses.
                    </li>
                </ul>
                <img src="https://raw.githubusercontent.com/billpottle/financial_simulator/refs/heads/main/fev_graph.jpg"
                    alt="FEV graph" style="max-width: 100%; margin: 10px 0;" />


                <p>The green line represents covering 100% of your expenses with passive and investment income. The box plots show the distribution of times that it happened. 
                    For instance, if the lower 'wisker' of the box plot is over the green line, you have a 90% chance of covering all your expenses that year. 
                </p>
            </div>
        </div>
</body>

</html>